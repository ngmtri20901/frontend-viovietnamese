{"version":3,"sources":["turbopack:///[project]/features/learn/hooks/index.ts","turbopack:///[project]/features/learn/hooks/use-exercise-result-saver.ts","turbopack:///[project]/features/learn/hooks/use-topic-progress.ts","turbopack:///[project]/features/learn/api/lesson-progress.ts","turbopack:///[project]/features/learn/utils/lesson-unlock-logic.ts","turbopack:///[project]/features/learn/hooks/use-lesson-unlock.ts","turbopack:///[project]/features/learn/hooks/use-topic-progress-stats.ts","turbopack:///[project]/app/(app)/learn/[topicSlug]/LessonsList.tsx","turbopack:///[project]/features/learn/components/lesson/index.ts","turbopack:///[project]/app/(app)/learn/[topicSlug]/TopicProgressStats.tsx"],"sourcesContent":["// Hook exports for the learn feature\r\nexport * from './use-exercise-session'\r\nexport * from './use-exercise-result-saver'\r\nexport * from './use-topic-progress'\r\nexport * from './use-lesson-unlock'\r\nexport * from './use-topic-progress-stats'\r\n","\"use client\"\r\n\r\nimport { useCallback, useRef } from 'react'\r\nimport { createClient } from '@/shared/lib/supabase/client'\r\nimport type { QuestionAttempt } from '@/features/learn/utils/exercise-utils'\r\n\r\nexport interface ExerciseResultData {\r\n  practiceSetId: string\r\n  userId: string\r\n  scorePercent: number\r\n  totalCorrect: number\r\n  totalIncorrect: number\r\n  totalSkipped: number\r\n  timeSpentSeconds: number\r\n  weakQuestionTypes?: Record<string, number>\r\n  attempts: QuestionAttempt[]\r\n  passed: boolean\r\n  lessonId?: number\r\n  topicId?: number\r\n}\r\n\r\n/**\r\n * Hook for saving exercise results to Supabase\r\n * Handles both practice_results and practice_result_details tables\r\n */\r\nexport function useExerciseResultSaver() {\r\n  const supabase = createClient()\r\n  const isSaving = useRef(false)\r\n\r\n  const saveExerciseResult = useCallback(async (data: ExerciseResultData) => {\r\n    // Prevent duplicate saves\r\n    if (isSaving.current) {\r\n      console.warn('[useExerciseResultSaver] Save already in progress, skipping')\r\n      return { success: false, error: 'Save already in progress' }\r\n    }\r\n\r\n    isSaving.current = true\r\n\r\n    try {\r\n      console.log('[useExerciseResultSaver] Starting save for practice set:', data.practiceSetId)\r\n\r\n      // 1. Get practice set details\r\n      const { data: practiceSet, error: practiceSetError } = await supabase\r\n        .from('practice_sets')\r\n        .select('lesson_id, topic_id, coin_reward, xp_reward, pass_threshold')\r\n        .eq('id', data.practiceSetId)\r\n        .single()\r\n\r\n      if (practiceSetError || !practiceSet) {\r\n        console.error('[useExerciseResultSaver] Practice set not found:', practiceSetError)\r\n        return { success: false, error: 'Practice set not found' }\r\n      }\r\n\r\n      // 2. Calculate attempt number\r\n      const { count: attemptCount } = await supabase\r\n        .from('practice_results')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('user_id', data.userId)\r\n        .eq('practice_set_id', data.practiceSetId)\r\n\r\n      const attemptNo = (attemptCount || 0) + 1\r\n\r\n      // 3. Check if this is first pass\r\n      const { data: existingPasses } = await supabase\r\n        .from('practice_results')\r\n        .select('passed')\r\n        .eq('user_id', data.userId)\r\n        .eq('practice_set_id', data.practiceSetId)\r\n        .eq('passed', true)\r\n\r\n      const isFirstPass = (!existingPasses || existingPasses.length === 0) && data.passed\r\n\r\n      // 4. Calculate weak question types\r\n      const weakQuestionTypes: Record<string, number> = {}\r\n      data.attempts.forEach(attempt => {\r\n        if (!attempt.grade.isCorrect) {\r\n          const questionType = (attempt as any).questionType || 'unknown'\r\n          weakQuestionTypes[questionType] = (weakQuestionTypes[questionType] || 0) + 1\r\n        }\r\n      })\r\n\r\n      // 5. Insert practice_results record\r\n      const { data: practiceResult, error: resultError } = await supabase\r\n        .from('practice_results')\r\n        .insert({\r\n          user_id: data.userId,\r\n          practice_set_id: data.practiceSetId,\r\n          practice_date: new Date().toISOString().split('T')[0],\r\n          score_percent: data.scorePercent,\r\n          total_correct: data.totalCorrect,\r\n          total_incorrect: data.totalIncorrect,\r\n          total_skipped: data.totalSkipped,\r\n          time_spent_seconds: data.timeSpentSeconds,\r\n          weak_question_types: weakQuestionTypes,\r\n          coins_earned: isFirstPass ? (practiceSet.coin_reward || 0) : 0,\r\n          xp_earned: isFirstPass ? (practiceSet.xp_reward || 0) : 0,\r\n          is_first_pass: isFirstPass,\r\n          passed: data.passed,\r\n          attempt_no: attemptNo,\r\n          status: 'completed',\r\n          pass_criteria: {\r\n            min_accuracy: practiceSet.pass_threshold || 80,\r\n            min_correct: null\r\n          }\r\n        })\r\n        .select()\r\n        .single()\r\n\r\n      if (resultError) {\r\n        console.error('[useExerciseResultSaver] Error saving practice_results:', resultError)\r\n        return { success: false, error: resultError.message }\r\n      }\r\n\r\n      console.log('[useExerciseResultSaver] Saved practice_results:', practiceResult.id)\r\n\r\n      // 6. Insert practice_result_details records\r\n      const detailsToInsert = data.attempts.map(attempt => ({\r\n        practice_result_id: practiceResult.id,\r\n        question_id: parseInt(attempt.questionId) || null,\r\n        is_correct: attempt.grade.isCorrect,\r\n        time_spent_ms: attempt.timeSpentMs,\r\n        answer_data: {\r\n          userAnswer: attempt.userAnswer,\r\n          score: attempt.grade.score,\r\n          feedback: attempt.grade.feedback\r\n        },\r\n        status: attempt.status || 'answered'\r\n      }))\r\n\r\n      const { error: detailsError } = await supabase\r\n        .from('practice_result_details')\r\n        .insert(detailsToInsert)\r\n\r\n      if (detailsError) {\r\n        console.error('[useExerciseResultSaver] Error saving practice_result_details:', detailsError)\r\n        // Don't fail completely if details save fails\r\n      } else {\r\n        console.log('[useExerciseResultSaver] Saved', detailsToInsert.length, 'practice_result_details')\r\n      }\r\n\r\n      // 7. Update/insert user_lesson_progress\r\n      if (practiceSet.lesson_id && practiceSet.topic_id) {\r\n        const { data: existingProgress } = await supabase\r\n          .from('user_lesson_progress')\r\n          .select('*')\r\n          .eq('user_id', data.userId)\r\n          .eq('lesson_id', practiceSet.lesson_id)\r\n          .single()\r\n\r\n        const now = new Date().toISOString()\r\n\r\n        if (existingProgress) {\r\n          // Update existing progress\r\n          const updateData: any = {\r\n            total_attempts: (existingProgress.total_attempts || 0) + 1,\r\n            last_attempted_at: now,\r\n            updated_at: now\r\n          }\r\n\r\n          // Update best score if current is better\r\n          if (data.scorePercent > (existingProgress.best_score_percent || 0)) {\r\n            updateData.best_score_percent = data.scorePercent\r\n          }\r\n\r\n          // Update status if passed\r\n          if (data.passed && existingProgress.status !== 'passed') {\r\n            updateData.status = 'passed'\r\n            updateData.passed_at = now\r\n          } else if (existingProgress.status === 'not_started') {\r\n            updateData.status = 'in_progress'\r\n          }\r\n\r\n          const { error: progressError } = await supabase\r\n            .from('user_lesson_progress')\r\n            .update(updateData)\r\n            .eq('id', existingProgress.id)\r\n\r\n          if (progressError) {\r\n            console.error('[useExerciseResultSaver] Error updating user_lesson_progress:', progressError)\r\n          }\r\n        } else {\r\n          // Insert new progress record\r\n          const { error: progressError } = await supabase\r\n            .from('user_lesson_progress')\r\n            .insert({\r\n              user_id: data.userId,\r\n              lesson_id: practiceSet.lesson_id,\r\n              topic_id: practiceSet.topic_id,\r\n              total_attempts: 1,\r\n              best_score_percent: data.scorePercent,\r\n              status: data.passed ? 'passed' : 'in_progress',\r\n              first_attempted_at: now,\r\n              last_attempted_at: now,\r\n              passed_at: data.passed ? now : null,\r\n              pass_threshold: practiceSet.pass_threshold || 80\r\n            })\r\n\r\n          if (progressError) {\r\n            console.error('[useExerciseResultSaver] Error inserting user_lesson_progress:', progressError)\r\n          }\r\n        }\r\n      }\r\n\r\n      // 8. Award coins and XP if first pass\r\n      if (isFirstPass) {\r\n        const { error: rewardError } = await supabase.rpc('award_user_rewards', {\r\n          p_user_id: data.userId,\r\n          p_coins: practiceSet.coin_reward || 0,\r\n          p_xp: practiceSet.xp_reward || 0,\r\n        })\r\n\r\n        if (rewardError) {\r\n          console.error('[useExerciseResultSaver] Error awarding rewards:', rewardError)\r\n        } else {\r\n          console.log('[useExerciseResultSaver] Awarded rewards:', {\r\n            coins: practiceSet.coin_reward,\r\n            xp: practiceSet.xp_reward\r\n          })\r\n        }\r\n      }\r\n\r\n      return { \r\n        success: true, \r\n        practiceResultId: practiceResult.id,\r\n        isFirstPass,\r\n        coinsEarned: isFirstPass ? (practiceSet.coin_reward || 0) : 0,\r\n        xpEarned: isFirstPass ? (practiceSet.xp_reward || 0) : 0\r\n      }\r\n    } catch (error) {\r\n      console.error('[useExerciseResultSaver] Unexpected error:', error)\r\n      return { \r\n        success: false, \r\n        error: error instanceof Error ? error.message : 'Unknown error' \r\n      }\r\n    } finally {\r\n      isSaving.current = false\r\n    }\r\n  }, [supabase])\r\n\r\n  return { saveExerciseResult }\r\n}\r\n","'use client'\r\n\r\nimport { useQuery } from '@tanstack/react-query'\r\nimport { useUserProfile } from '@/shared/hooks/use-user-profile'\r\nimport { getUserTopicProgress, getZoneCompletionStats, type UserLessonProgress } from '@/features/learn/api'\r\nimport { queryKeys } from '@/shared/hooks/query-keys'\r\n\r\n/**\r\n * Hook to get user progress for all lessons in a topic\r\n */\r\nexport function useTopicProgress(topicId: number, initialData?: any[]) {\r\n  const { user } = useUserProfile()\r\n\r\n  const { data: topicProgress = [], isLoading } = useQuery({\r\n    queryKey: queryKeys.lessonProgress.topic(user?.id ?? '', topicId),\r\n    queryFn: async () => {\r\n      if (!user?.id) return initialData ?? []\r\n      return getUserTopicProgress(user.id, topicId)\r\n    },\r\n    enabled: !!user?.id,\r\n    initialData: initialData, // Use server-side data immediately\r\n    staleTime: 30 * 1000, // 30 seconds\r\n    gcTime: 5 * 60 * 1000, // 5 minutes\r\n  })\r\n\r\n  return {\r\n    topicProgress: topicProgress as UserLessonProgress[],\r\n    isLoading,\r\n  }\r\n}\r\n\r\n/**\r\n * Hook to get zone completion statistics\r\n * Returns number of completed topics vs total topics in a zone\r\n */\r\nexport function useZoneCompletion(zoneId: number) {\r\n  const { user } = useUserProfile()\r\n\r\n  const { data, isLoading } = useQuery({\r\n    queryKey: [...queryKeys.lessonProgress.zone(user?.id ?? '', zoneId), 'completion'],\r\n    queryFn: async () => {\r\n      if (!user?.id) return { completed: 0, total: 0 }\r\n      return getZoneCompletionStats({\r\n        userId: user.id,\r\n        zoneId,\r\n      })\r\n    },\r\n    enabled: !!user?.id && zoneId > 0,\r\n    staleTime: 60 * 1000, // 1 minute\r\n    gcTime: 10 * 60 * 1000, // 10 minutes\r\n  })\r\n\r\n  return {\r\n    completed: data?.completed ?? 0,\r\n    total: data?.total ?? 0,\r\n    isLoading,\r\n  }\r\n}\r\n\r\n","import { createClient } from '@/shared/lib/supabase/client'\r\nimport type { Database } from '@/types/supabase'\r\n\r\ntype PracticeResult = Database['public']['Tables']['practice_results']['Row']\r\ntype PracticeResultInsert = Database['public']['Tables']['practice_results']['Insert']\r\n\r\nexport interface UserLessonProgress {\r\n  id: string\r\n  user_id: string\r\n  lesson_id: number\r\n  topic_id: number\r\n  best_score_percent: number\r\n  total_attempts: number\r\n  pass_threshold: number\r\n  status: 'not_started' | 'in_progress' | 'passed'\r\n  first_attempted_at: string | null\r\n  last_attempted_at: string | null\r\n  passed_at: string | null\r\n}\r\n\r\nexport interface SubmitAttemptParams {\r\n  practiceSetId: string\r\n  scorePercent: number\r\n  totalCorrect: number\r\n  totalIncorrect: number\r\n  totalSkipped: number\r\n  timeSpentSeconds: number\r\n  weakQuestionTypes?: Record<string, any>\r\n}\r\n\r\n/**\r\n * Submit a lesson attempt and track progress\r\n * Awards coins and XP only on first pass (score >= threshold and no previous pass)\r\n */\r\nexport async function submitLessonAttempt(\r\n  params: SubmitAttemptParams\r\n): Promise<{ success: boolean; result: PracticeResult | null; error?: string }> {\r\n  try {\r\n    const supabase = createClient()\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    \r\n    if (!user) {\r\n      return { success: false, result: null, error: 'User not authenticated' }\r\n    }\r\n\r\n    // Get practice set details including reward information\r\n    const { data: practiceSet } = await supabase\r\n      .from('practice_sets')\r\n      .select('lesson_id, coin_reward, xp_reward, pass_threshold')\r\n      .eq('id', params.practiceSetId)\r\n      .single()\r\n\r\n    if (!practiceSet?.lesson_id) {\r\n      return { success: false, result: null, error: 'Practice set not linked to lesson' }\r\n    }\r\n\r\n    // Check for existing pass to determine if this is first pass\r\n    const { data: existingResults } = await supabase\r\n      .from('practice_results')\r\n      .select('score_percent')\r\n      .eq('user_id', user.id)\r\n      .eq('practice_set_id', params.practiceSetId)\r\n      .gte('score_percent', practiceSet.pass_threshold || 80)\r\n\r\n    const isFirstPass = !existingResults || existingResults.length === 0\r\n    const shouldReward = isFirstPass && params.scorePercent >= (practiceSet.pass_threshold || 80)\r\n\r\n    // Insert practice result - using ONLY existing columns in practice_results table\r\n    const { data: result, error } = await supabase\r\n      .from('practice_results')\r\n      .insert({\r\n        user_id: user.id,\r\n        practice_set_id: params.practiceSetId,\r\n        practice_date: new Date().toISOString().split('T')[0],\r\n        score_percent: params.scorePercent,\r\n        total_correct: params.totalCorrect,\r\n        total_incorrect: params.totalIncorrect,\r\n        weak_question_types: params.weakQuestionTypes || {},\r\n        // Note: time_taken column exists but expects time type, not integer\r\n        // Note: total_skipped, coins_earned, xp_earned, is_first_pass, time_spent_seconds \r\n        // may not exist - will be added via ALTER TABLE migration\r\n      })\r\n      .select()\r\n      .single()\r\n\r\n    if (error) {\r\n      console.error('[submitLessonAttempt] Error:', error)\r\n      console.error('[submitLessonAttempt] Error details:', JSON.stringify(error, null, 2))\r\n      return { success: false, result: null, error: error.message }\r\n    }\r\n\r\n    // Award coins and XP to user profile if first pass\r\n    if (shouldReward) {\r\n      const { error: rewardError } = await supabase.rpc('award_user_rewards', {\r\n        p_user_id: user.id,\r\n        p_coins: practiceSet.coin_reward || 0,\r\n        p_xp: practiceSet.xp_reward || 0,\r\n      })\r\n\r\n      if (rewardError) {\r\n        console.error('[submitLessonAttempt] Reward error:', rewardError)\r\n        // Don't fail the whole operation if reward fails\r\n      }\r\n    }\r\n\r\n    return { success: true, result, error: undefined }\r\n  } catch (err) {\r\n    console.error('[submitLessonAttempt] Exception:', err)\r\n    return { \r\n      success: false, \r\n      result: null, \r\n      error: err instanceof Error ? err.message : 'Unknown error' \r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Get user progress for a specific lesson\r\n */\r\nexport async function getUserLessonProgress(\r\n  userId: string,\r\n  lessonId: number\r\n): Promise<UserLessonProgress | null> {\r\n  const supabase = createClient()\r\n  \r\n  const { data, error } = await supabase\r\n    .from('user_lesson_progress')\r\n    .select('*')\r\n    .eq('user_id', userId)\r\n    .eq('lesson_id', lessonId)\r\n    .single()\r\n\r\n  if (error || !data) return null\r\n  return data as UserLessonProgress\r\n}\r\n\r\n/**\r\n * Get all user progress records for a specific topic\r\n */\r\nexport async function getUserTopicProgress(\r\n  userId: string,\r\n  topicId: number\r\n): Promise<UserLessonProgress[]> {\r\n  const supabase = createClient()\r\n  \r\n  const { data, error } = await supabase\r\n    .from('user_lesson_progress')\r\n    .select('*')\r\n    .eq('user_id', userId)\r\n    .eq('topic_id', topicId)\r\n    .order('lesson_id', { ascending: true })\r\n\r\n  if (error || !data) return []\r\n  return data as UserLessonProgress[]\r\n}\r\n\r\n/**\r\n * Get all user progress records for a specific zone\r\n */\r\nexport async function getUserZoneProgress(\r\n  userId: string,\r\n  zoneId: number\r\n): Promise<UserLessonProgress[]> {\r\n  const supabase = createClient()\r\n  \r\n  // First get all topics in the zone\r\n  const { data: topics, error: topicsError } = await supabase\r\n    .from('topics')\r\n    .select('topic_id')\r\n    .eq('zone_id', zoneId)\r\n\r\n  if (topicsError || !topics || topics.length === 0) return []\r\n\r\n  const topicIds = topics.map(t => t.topic_id)\r\n\r\n  // Get progress for all lessons in these topics\r\n  const { data, error } = await supabase\r\n    .from('user_lesson_progress')\r\n    .select('*')\r\n    .eq('user_id', userId)\r\n    .in('topic_id', topicIds)\r\n    .order('topic_id', { ascending: true })\r\n\r\n  if (error || !data) return []\r\n  return data as UserLessonProgress[]\r\n}\r\n\r\n/**\r\n * Calculate zone completion statistics\r\n * Returns number of completed topics vs total topics in zone\r\n */\r\nexport async function getZoneCompletionStats(params: {\r\n  userId: string\r\n  zoneId: number\r\n}): Promise<{ completed: number; total: number }> {\r\n  const { userId, zoneId } = params\r\n  const supabase = createClient()\r\n\r\n  // Get all topics in the zone\r\n  const { data: topics, error: topicsError } = await supabase\r\n    .from('topics')\r\n    .select('topic_id')\r\n    .eq('zone_id', zoneId)\r\n\r\n  if (topicsError || !topics) {\r\n    return { completed: 0, total: 0 }\r\n  }\r\n\r\n  const topicIds = topics.map(t => t.topic_id)\r\n  const totalTopics = topicIds.length\r\n\r\n  if (totalTopics === 0) {\r\n    return { completed: 0, total: 0 }\r\n  }\r\n\r\n  // Get all lessons in these topics\r\n  const { data: lessons, error: lessonsError } = await supabase\r\n    .from('lessons')\r\n    .select('id, topic_id')\r\n    .in('topic_id', topicIds)\r\n\r\n  if (lessonsError || !lessons) {\r\n    return { completed: 0, total: totalTopics }\r\n  }\r\n\r\n  // Get user progress for all lessons in this zone (only passed)\r\n  const lessonIds = lessons.map(l => l.id)\r\n  \r\n  const { data: progressRecords, error: progressError } = await supabase\r\n    .from('user_lesson_progress')\r\n    .select('lesson_id, topic_id, status')\r\n    .eq('user_id', userId)\r\n    .in('lesson_id', lessonIds)\r\n    .eq('status', 'passed')\r\n\r\n  if (progressError || !progressRecords) {\r\n    return { completed: 0, total: totalTopics }\r\n  }\r\n\r\n  // Count how many topics have ALL lessons passed\r\n  const topicCompletionMap = new Map<number, { total: number; passed: number }>()\r\n\r\n  // Initialize counts\r\n  topicIds.forEach((topicId: number) => {\r\n    const topicLessons = lessons.filter(l => l.topic_id === topicId)\r\n    topicCompletionMap.set(topicId, { total: topicLessons.length, passed: 0 })\r\n  })\r\n\r\n  // Count passed lessons per topic\r\n  progressRecords.forEach((progress: any) => {\r\n    const topicData = topicCompletionMap.get(progress.topic_id)\r\n    if (topicData) {\r\n      topicData.passed += 1\r\n    }\r\n  })\r\n\r\n  // Count how many topics are fully completed (all lessons passed)\r\n  let completedTopics = 0\r\n  topicCompletionMap.forEach((data) => {\r\n    if (data.total > 0 && data.passed >= data.total) {\r\n      completedTopics += 1\r\n    }\r\n  })\r\n\r\n  return { completed: completedTopics, total: totalTopics }\r\n}\r\n","import type { UserLessonProgress } from '@/features/learn/api'\r\n\r\nexport type SubscriptionTier = 'FREE' | 'PLUS' | 'UNLIMITED'\r\n\r\nexport interface LessonUnlockStatus {\r\n  isLocked: boolean\r\n  reason?: 'tier_restriction' | 'previous_incomplete' | 'zone_locked' | 'login_required' | 'loading'\r\n  requiredAction?: string\r\n  completedTopicsInPrevZone?: number\r\n  totalTopicsInPrevZone?: number\r\n}\r\n\r\n/**\r\n * Check if a lesson should be unlocked based on tier and progress\r\n * \r\n * Rules:\r\n * - UNLIMITED: All lessons unlocked\r\n * - PLUS: All zones accessible, sequential unlock within topics\r\n * - FREE: Progressive zone unlock\r\n *   - Beginner (level 1) always accessible\r\n *   - Complete ALL topics in zone N to unlock first lesson of each topic in zone N+1\r\n *   - Sequential unlock within topics\r\n */\r\nexport function checkLessonUnlock(params: {\r\n  userTier: SubscriptionTier | null\r\n  isAuthenticated: boolean\r\n  zoneLevel: number // 1 = Beginner, 2 = Elementary, etc.\r\n  lessonSortOrder: number\r\n  previousLessonProgress: UserLessonProgress | null\r\n  completedTopicsInPreviousZone?: number // For FREE tier zone unlock check\r\n  totalTopicsInPreviousZone?: number\r\n}): LessonUnlockStatus {\r\n  const { \r\n    userTier, \r\n    isAuthenticated, \r\n    zoneLevel, \r\n    lessonSortOrder, \r\n    previousLessonProgress,\r\n    completedTopicsInPreviousZone = 0,\r\n    totalTopicsInPreviousZone = 0\r\n  } = params\r\n\r\n  // Not authenticated - all locked\r\n  if (!isAuthenticated) {\r\n    return {\r\n      isLocked: true,\r\n      reason: 'login_required',\r\n      requiredAction: 'Please log in to access lessons',\r\n    }\r\n  }\r\n\r\n  // UNLIMITED tier - all unlocked\r\n  if (userTier === 'UNLIMITED') {\r\n    return { isLocked: false }\r\n  }\r\n\r\n  // FREE tier - progressive zone unlocking based on completion\r\n  if (userTier === 'FREE') {\r\n    // Beginner zone (level 1) is always accessible\r\n    if (zoneLevel === 1) {\r\n      // First lesson in topic always unlocked\r\n      if (lessonSortOrder === 1) {\r\n        return { isLocked: false }\r\n      }\r\n\r\n      // Check if previous lesson in topic passed\r\n      if (!previousLessonProgress || previousLessonProgress.status !== 'passed') {\r\n        return {\r\n          isLocked: true,\r\n          reason: 'previous_incomplete',\r\n          requiredAction: 'Complete the previous lesson in this topic first',\r\n        }\r\n      }\r\n\r\n      return { isLocked: false }\r\n    }\r\n\r\n    // For zones beyond beginner (level > 1), check if ALL topics in previous zone are completed\r\n    const allTopicsInPrevZoneCompleted = \r\n      totalTopicsInPreviousZone > 0 && \r\n      completedTopicsInPreviousZone >= totalTopicsInPreviousZone\r\n\r\n    if (!allTopicsInPrevZoneCompleted) {\r\n      const zoneName = getZoneName(zoneLevel - 1)\r\n      return {\r\n        isLocked: true,\r\n        reason: 'zone_locked',\r\n        requiredAction: `Complete all topics in ${zoneName} zone to unlock this zone (${completedTopicsInPreviousZone}/${totalTopicsInPreviousZone} topics completed)`,\r\n        completedTopicsInPrevZone: completedTopicsInPreviousZone,\r\n        totalTopicsInPrevZone: totalTopicsInPreviousZone,\r\n      }\r\n    }\r\n\r\n    // Zone is unlocked for FREE tier, now check lesson unlock within topic\r\n    // First lesson in each topic is unlocked when zone is unlocked\r\n    if (lessonSortOrder === 1) {\r\n      return { isLocked: false }\r\n    }\r\n\r\n    // Check if previous lesson in topic passed\r\n    if (!previousLessonProgress || previousLessonProgress.status !== 'passed') {\r\n      return {\r\n        isLocked: true,\r\n        reason: 'previous_incomplete',\r\n        requiredAction: 'Complete the previous lesson in this topic first',\r\n      }\r\n    }\r\n\r\n    return { isLocked: false }\r\n  }\r\n\r\n  // PLUS tier - all zones, sequential within topics\r\n  if (userTier === 'PLUS') {\r\n    // First lesson always unlocked\r\n    if (lessonSortOrder === 1) {\r\n      return { isLocked: false }\r\n    }\r\n\r\n    // Check if previous lesson passed\r\n    if (!previousLessonProgress || previousLessonProgress.status !== 'passed') {\r\n      return {\r\n        isLocked: true,\r\n        reason: 'previous_incomplete',\r\n        requiredAction: 'Complete the previous lesson first',\r\n      }\r\n    }\r\n\r\n    return { isLocked: false }\r\n  }\r\n\r\n  // Default: locked\r\n  return {\r\n    isLocked: true,\r\n    reason: 'tier_restriction',\r\n    requiredAction: 'Upgrade to access this lesson',\r\n  }\r\n}\r\n\r\n/**\r\n * Get all unlocked lesson IDs in a topic\r\n * Returns a Set of unlocked lesson IDs\r\n */\r\nexport function getUnlockedLessonsInTopic(params: {\r\n  userTier: SubscriptionTier\r\n  zoneLevel: number\r\n  lessonsInTopic: Array<{ id: number; sort_order: number }>\r\n  progressRecords: UserLessonProgress[]\r\n  completedTopicsInPreviousZone?: number\r\n  totalTopicsInPreviousZone?: number\r\n}): Set<number> {\r\n  const { \r\n    userTier, \r\n    zoneLevel, \r\n    lessonsInTopic, \r\n    progressRecords,\r\n    completedTopicsInPreviousZone = 0,\r\n    totalTopicsInPreviousZone = 0\r\n  } = params\r\n  const unlockedSet = new Set<number>()\r\n\r\n  // UNLIMITED: all unlocked\r\n  if (userTier === 'UNLIMITED') {\r\n    return new Set(lessonsInTopic.map(l => l.id))\r\n  }\r\n\r\n  // FREE: check progressive zone unlock\r\n  if (userTier === 'FREE') {\r\n    // Beginner zone (level 1) always accessible\r\n    if (zoneLevel > 1) {\r\n      // Check if ALL topics in previous zone are completed\r\n      const allTopicsInPrevZoneCompleted = \r\n        totalTopicsInPreviousZone > 0 && \r\n        completedTopicsInPreviousZone >= totalTopicsInPreviousZone\r\n\r\n      if (!allTopicsInPrevZoneCompleted) {\r\n        return unlockedSet // None unlocked - zone is locked\r\n      }\r\n    }\r\n  }\r\n\r\n  // Sort lessons by sort_order\r\n  const sortedLessons = [...lessonsInTopic].sort((a, b) => a.sort_order - b.sort_order)\r\n\r\n  // Sequential unlocking logic\r\n  for (let i = 0; i < sortedLessons.length; i++) {\r\n    const lesson = sortedLessons[i]\r\n\r\n    // First lesson always unlocked (if zone allowed)\r\n    if (i === 0) {\r\n      unlockedSet.add(lesson.id)\r\n      continue\r\n    }\r\n\r\n    // Check if previous lesson passed\r\n    const prevLesson = sortedLessons[i - 1]\r\n    const prevProgress = progressRecords.find(p => p.lesson_id === prevLesson.id)\r\n\r\n    if (prevProgress && prevProgress.status === 'passed') {\r\n      unlockedSet.add(lesson.id)\r\n    } else {\r\n      // Sequential logic: stop unlocking once we hit a locked lesson\r\n      break\r\n    }\r\n  }\r\n\r\n  return unlockedSet\r\n}\r\n\r\n/**\r\n * Check if a zone is unlocked for a user based on tier and progress\r\n */\r\nexport function isZoneUnlocked(params: {\r\n  userTier: SubscriptionTier\r\n  zoneLevel: number\r\n  completedTopicsInPreviousZone: number\r\n  totalTopicsInPreviousZone: number\r\n}): boolean {\r\n  const { userTier, zoneLevel, completedTopicsInPreviousZone, totalTopicsInPreviousZone } = params\r\n\r\n  // UNLIMITED tier: all zones unlocked\r\n  if (userTier === 'UNLIMITED') {\r\n    return true\r\n  }\r\n\r\n  // PLUS tier: all zones unlocked\r\n  if (userTier === 'PLUS') {\r\n    return true\r\n  }\r\n\r\n  // FREE tier: progressive zone unlock\r\n  // Beginner zone (level 1) always unlocked\r\n  if (zoneLevel === 1) {\r\n    return true\r\n  }\r\n\r\n  // For other zones, check if ALL topics in previous zone are completed\r\n  return totalTopicsInPreviousZone > 0 && \r\n         completedTopicsInPreviousZone >= totalTopicsInPreviousZone\r\n}\r\n\r\n/**\r\n * Get zone name by level for display purposes\r\n */\r\nfunction getZoneName(level: number): string {\r\n  const zoneNames: Record<number, string> = {\r\n    1: 'Beginner',\r\n    2: 'Elementary',\r\n    3: 'Intermediate',\r\n    4: 'Advanced',\r\n    5: 'Expert',\r\n  }\r\n  return zoneNames[level] || `Zone ${level}`\r\n}\r\n\r\n/**\r\n * Calculate overall progress percentage for a zone\r\n */\r\nexport function calculateZoneProgressPercent(params: {\r\n  completedTopics: number\r\n  totalTopics: number\r\n}): number {\r\n  const { completedTopics, totalTopics } = params\r\n  if (totalTopics === 0) return 0\r\n  return Math.round((completedTopics / totalTopics) * 100)\r\n}\r\n\r\n/**\r\n * Get next unlockable zone level for FREE tier users\r\n */\r\nexport function getNextUnlockableZone(params: {\r\n  currentZoneLevel: number\r\n  completedTopicsInCurrentZone: number\r\n  totalTopicsInCurrentZone: number\r\n}): { nextZoneLevel: number; isReadyToUnlock: boolean } {\r\n  const { currentZoneLevel, completedTopicsInCurrentZone, totalTopicsInCurrentZone } = params\r\n  \r\n  const isReadyToUnlock = \r\n    totalTopicsInCurrentZone > 0 && \r\n    completedTopicsInCurrentZone >= totalTopicsInCurrentZone\r\n\r\n  return {\r\n    nextZoneLevel: currentZoneLevel + 1,\r\n    isReadyToUnlock,\r\n  }\r\n}\r\n","'use client'\r\n\r\nimport { useMemo } from 'react'\r\nimport { useUserProfile } from '@/shared/hooks/use-user-profile'\r\nimport { useTopicProgress } from './use-topic-progress'\r\nimport { useZoneCompletion } from './use-topic-progress'\r\nimport { checkLessonUnlock, type LessonUnlockStatus } from '@/features/learn/utils/lesson-unlock-logic'\r\nimport type { SubscriptionTier } from '@/features/learn/utils/lesson-unlock-logic'\r\n\r\ninterface UseLessonUnlockParams {\r\n  topicId: number\r\n  zoneId: number\r\n  zoneLevel: number\r\n  lessonId: number\r\n  lessonSortOrder: number\r\n  previousLessonId?: number | null\r\n}\r\n\r\n/**\r\n * Hook to determine if a lesson is unlocked based on user tier and progress\r\n */\r\nexport function useLessonUnlock(params: UseLessonUnlockParams): LessonUnlockStatus {\r\n  const { topicId, zoneId, zoneLevel, lessonId, lessonSortOrder, previousLessonId } = params\r\n  const { user, profile, isAuthenticated } = useUserProfile()\r\n  const { topicProgress } = useTopicProgress(topicId)\r\n  const { completed: prevZoneCompleted, total: prevZoneTotal } = useZoneCompletion(zoneId - 1)\r\n\r\n  const unlockStatus = useMemo(() => {\r\n    const tier = (profile?.subscription_type ?? 'FREE') as SubscriptionTier\r\n\r\n    // Find previous lesson progress\r\n    const previousLessonProgress = previousLessonId\r\n      ? topicProgress.find(p => p.lesson_id === previousLessonId) ?? null\r\n      : null\r\n\r\n    return checkLessonUnlock({\r\n      userTier: tier,\r\n      isAuthenticated,\r\n      zoneLevel,\r\n      lessonSortOrder,\r\n      previousLessonProgress,\r\n      completedTopicsInPreviousZone: prevZoneCompleted,\r\n      totalTopicsInPreviousZone: prevZoneTotal,\r\n    })\r\n  }, [\r\n    profile?.subscription_type,\r\n    isAuthenticated,\r\n    zoneLevel,\r\n    lessonSortOrder,\r\n    previousLessonId,\r\n    topicProgress,\r\n    prevZoneCompleted,\r\n    prevZoneTotal,\r\n  ])\r\n\r\n  return unlockStatus\r\n}\r\n\r\n","'use client'\r\n\r\nimport { useQuery } from '@tanstack/react-query'\r\nimport { useUserProfile } from '@/shared/hooks/use-user-profile'\r\nimport { getUserTopicProgress } from '@/features/learn/api'\r\nimport { queryKeys } from '@/shared/hooks/query-keys'\r\n\r\n/**\r\n * Hook to get topic progress statistics (completed lessons count)\r\n */\r\nexport function useTopicProgressStats(topicId: number, initialData?: any[]) {\r\n  const { user } = useUserProfile()\r\n\r\n  const { data: topicProgress = [], isLoading } = useQuery({\r\n    queryKey: queryKeys.lessonProgress.topic(user?.id ?? '', topicId),\r\n    queryFn: async () => {\r\n      if (!user?.id) return initialData ?? []\r\n      return getUserTopicProgress(user.id, topicId)\r\n    },\r\n    enabled: !!user?.id,\r\n    initialData: initialData, // Use server-side data immediately\r\n    staleTime: 30 * 1000, // 30 seconds\r\n    gcTime: 5 * 60 * 1000, // 5 minutes\r\n  })\r\n\r\n  // Count completed lessons (status === 'passed')\r\n  const completedLessons = topicProgress.filter(p => p.status === 'passed').length\r\n\r\n  return {\r\n    completedLessons,\r\n    isLoading,\r\n  }\r\n}\r\n\r\n","\"use client\"\r\n\r\nimport Link from \"next/link\"\r\nimport { Button } from \"@/shared/components/ui/button\"\r\nimport { Card, CardContent } from \"@/shared/components/ui/card\"\r\nimport { Clock, Award, CheckCircle2, Lock } from \"lucide-react\"\r\nimport { useUserProfile } from \"@/shared/hooks/use-user-profile\"\r\nimport { useTopicProgress, useZoneCompletion } from \"@/features/learn/hooks\"\r\nimport { LessonProgressBadge, LessonUnlockTooltip } from \"@/features/learn/components/lesson\"\r\nimport { checkLessonUnlock } from \"@/features/learn/utils/lesson-unlock-logic\"\r\nimport type { SubscriptionTier } from \"@/features/learn/utils/lesson-unlock-logic\"\r\n\r\ntype LessonRow = {\r\n  id: number\r\n  slug: string\r\n  lesson_name: string\r\n  duration_minutes: number | null\r\n  coins_reward: number | null\r\n  sort_order: number | null\r\n  status: string | null\r\n}\r\n\r\ninterface LessonsListProps {\r\n  lessons: LessonRow[]\r\n  topicId: number\r\n  topicSlug: string\r\n  zoneId: number\r\n  zoneLevel: number\r\n  initialProgress?: any[]\r\n}\r\n\r\nexport default function LessonsList({\r\n  lessons,\r\n  topicId,\r\n  topicSlug,\r\n  zoneId,\r\n  zoneLevel,\r\n  initialProgress\r\n}: LessonsListProps) {\r\n  const { profile, user } = useUserProfile()\r\n  const { topicProgress } = useTopicProgress(topicId, initialProgress)\r\n  \r\n  // Get zone completion stats for previous zone (for FREE tier unlock check)\r\n  const { completed: prevZoneCompleted, total: prevZoneTotal } = useZoneCompletion(zoneId - 1)\r\n\r\n  // Get user tier\r\n  const tier = (profile?.subscription_type ?? 'FREE') as SubscriptionTier\r\n\r\n  // Lessons are already sorted by sort_order ascending from server\r\n  return (\r\n    <div className=\"grid gap-4\">\r\n      {lessons.map((lesson, index) => {\r\n        // Get progress for this lesson\r\n        const progress = topicProgress.find(p => p.lesson_id === lesson.id)\r\n        \r\n        // Find previous lesson by sort_order\r\n        const previousLesson = index > 0 ? lessons[index - 1] : null\r\n        const previousProgress = previousLesson \r\n          ? topicProgress.find(p => p.lesson_id === previousLesson.id)\r\n          : null\r\n\r\n        // Check unlock status using the utility function (not hook, since we're in a map)\r\n        const unlockStatus = checkLessonUnlock({\r\n          userTier: tier,\r\n          isAuthenticated: !!user,\r\n          zoneLevel,\r\n          lessonSortOrder: lesson.sort_order ?? (index + 1),\r\n          previousLessonProgress: previousProgress ?? null,\r\n          completedTopicsInPreviousZone: prevZoneCompleted,\r\n          totalTopicsInPreviousZone: prevZoneTotal,\r\n        })\r\n\r\n        const isLocked = unlockStatus.isLocked\r\n\r\n        return (\r\n          <LessonUnlockTooltip key={lesson.slug} unlockStatus={unlockStatus}>\r\n            <Card\r\n              className={`transition-all duration-300 hover:shadow-lg ${\r\n                isLocked ? \"opacity-60 cursor-not-allowed\" : \"hover:scale-[1.02]\"\r\n              }`}\r\n            >\r\n              <CardContent className=\"p-6\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div className=\"flex items-center gap-4 flex-1\">\r\n                    {/* Status Icon */}\r\n                    <div\r\n                      className={`w-12 h-12 rounded-full flex items-center justify-center border-2 ${\r\n                        progress?.status === 'passed'\r\n                          ? \"bg-green-500 border-green-500 text-white\"\r\n                          : isLocked\r\n                          ? \"bg-gray-200 border-gray-300 text-gray-500\"\r\n                          : \"bg-blue-50 border-[#067BC2] text-[#067BC2]\"\r\n                      }`}\r\n                    >\r\n                      {progress?.status === 'passed' ? (\r\n                        <CheckCircle2 size={24} />\r\n                      ) : isLocked ? (\r\n                        <Lock size={20} />\r\n                      ) : (\r\n                        <span className=\"font-bold\">{lesson.sort_order ?? (index + 1)}</span>\r\n                      )}\r\n                    </div>\r\n\r\n                    {/* Lesson Info */}\r\n                    <div className=\"flex-1\">\r\n                      <h4 className=\"text-lg font-semibold text-gray-900 mb-1\">\r\n                        {lesson.lesson_name}\r\n                      </h4>\r\n\r\n                      <div className=\"flex items-center gap-4 text-sm text-gray-600\">\r\n                        <span className=\"flex items-center gap-1\">\r\n                          <Clock size={14} />\r\n                          ~{lesson.duration_minutes ?? 15} min\r\n                        </span>\r\n                        <span className=\"flex items-center gap-1\">\r\n                          <Award size={14} />\r\n                          {lesson.coins_reward ?? 50} coins\r\n                        </span>\r\n                      </div>\r\n\r\n                      {/* Progress Badge */}\r\n                      {progress && (\r\n                        <div className=\"mt-2 inline-block\">\r\n                          <LessonProgressBadge\r\n                            status={progress.status}\r\n                            bestScore={progress.best_score_percent}\r\n                            passThreshold={progress.pass_threshold}\r\n                          />\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Action */}\r\n                  <div>\r\n                    {isLocked ? (\r\n                      <Button disabled variant=\"secondary\" className=\"px-6\">\r\n                        <Lock size={16} className=\"mr-2\" />\r\n                        Locked\r\n                      </Button>\r\n                    ) : (\r\n                      <Button \r\n                        asChild\r\n                        className=\"px-6 bg-[#067BC2] hover:bg-[#055a9f]\"\r\n                      >\r\n                        <Link href={`/learn/${topicSlug}/${lesson.slug}`}>\r\n                          {progress?.status === 'passed' ? 'Review' : 'Start Lesson'}\r\n                        </Link>\r\n                      </Button>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          </LessonUnlockTooltip>\r\n        )\r\n      })}\r\n    </div>\r\n  )\r\n}\r\n","// Lesson component exports\r\nexport { default as DialoguePlayer } from './DialoguePlayer'\r\nexport { default as StorybookPopup } from './StorybookPopup'\r\nexport { default as GrammarCarousel } from './GrammarCarousel'\r\nexport { default as ExampleSentences } from './ExampleSentences'\r\nexport { default as KeyVocabulary } from './KeyVocabulary'\r\nexport { default as UserCoins } from './UserCoins'\r\nexport { default as ZoneSection } from './ZoneSection'\r\nexport * from './LessonProgressBadge'\r\nexport * from './LessonUnlockTooltip'\r\nexport * from './TopicCard'\r\n","\"use client\"\r\n\r\nimport { BookOpen, CheckCircle2 } from \"lucide-react\"\r\nimport { Progress } from \"@/shared/components/ui/progress\"\r\nimport { useTopicProgressStats } from \"@/features/learn/hooks\"\r\n\r\ninterface TopicProgressStatsProps {\r\n  topicId: number\r\n  totalLessons: number\r\n  initialProgress?: any[]\r\n}\r\n\r\nexport default function TopicProgressStats({ topicId, totalLessons, initialProgress }: TopicProgressStatsProps) {\r\n  const { completedLessons, isLoading } = useTopicProgressStats(topicId, initialProgress)\r\n\r\n  // Calculate correct percentage based on total lessons in topic\r\n  const displayCompleted = completedLessons > 0 ? completedLessons : 0\r\n  const displayTotal = totalLessons\r\n  const displayPercentage = totalLessons > 0 ? Math.round((displayCompleted / totalLessons) * 100) : 0\r\n\r\n  console.log('[TopicProgressStats] Debug:', {\r\n    topicId,\r\n    completedLessons,\r\n    totalLessons,\r\n    displayPercentage\r\n  })\r\n\r\n  return (\r\n    <div className=\"mt-4 space-y-3 bg-black/30 backdrop-blur-sm p-3 rounded-lg border border-white/10\">\r\n      <div className=\"flex flex-col sm:flex-row sm:items-center gap-3 text-gray-200\">\r\n        <span className=\"flex items-center gap-2 text-sm whitespace-nowrap\">\r\n          <BookOpen size={16} />\r\n          <span>{displayTotal} lessons</span>\r\n        </span>\r\n        <span className=\"flex items-center gap-2 text-sm whitespace-nowrap\">\r\n          <CheckCircle2 size={16} />\r\n          <span>{displayCompleted} completed</span>\r\n        </span>\r\n      </div>\r\n      \r\n      <div className=\"space-y-1.5\">\r\n        <div className=\"flex justify-between text-sm font-medium text-gray-100\">\r\n          <span>Your Progress</span>\r\n          <span>{displayPercentage}%</span>\r\n        </div>\r\n        {/* Compact progress bar */}\r\n        <Progress \r\n          value={displayPercentage} \r\n          className=\"h-1.5 bg-white/20 [&>div]:bg-teal-400\" \r\n        />\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n"],"names":[],"mappings":"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"}