module.exports=[864513,858501,a=>{"use strict";a.s(["ExerciseProvider",()=>u,"useExercise",()=>v],864513);var b=a.i(187924),c=a.i(572131),d=a.i(875757),e=a.i(489026),f=a.i(937927),g=a.i(718404),h=a.i(439193);a.s(["calculateAccuracy",()=>r,"clearExerciseSession",()=>o,"getQuestionAttempt",()=>q,"gradeQuestion",()=>k,"isExercisePassed",()=>s,"loadExerciseSession",()=>n,"saveExerciseSession",()=>m,"saveQuestionAttempt",()=>p],858501);var i=a.i(601876);let j="1.0.0";function k(a,b){switch(a.type){case"multiple-choice":{let c=b===a.correctChoiceId;return{isCorrect:c,score:+!!c,feedback:c?"Correct!":`Incorrect. The correct answer is: ${a.choices.find(b=>b.id===a.correctChoiceId)?.text}`}}case"word-matching":{let c=a.pairs.length,d=0,e=(d=Array.isArray(b)?b.filter(b=>a.pairs.some(a=>a.id===b)).length:Object.values(b||{}).filter(b=>a.pairs.some(a=>a.id===b.pairId&&a.vietnamese===b.vietnamese)).length)===c;return{isCorrect:e,score:d/c,feedback:e?"Perfect matching!":`${d}/${c} pairs correct`}}case"synonyms-matching":{let c=a.pairs.length,d=0,e=(d=Array.isArray(b)?b.filter(b=>a.pairs.some(a=>a.id===b)).length:Object.values(b||{}).filter(b=>a.pairs.some(a=>a.id===b.pairId&&a.word2===b.word2)).length)===c;return{isCorrect:e,score:d/c,feedback:e?"All synonyms matched correctly!":`${d}/${c} pairs correct`}}case"choose-words":{let c=a.question_data,d=Array.isArray(b)?b:[];if(c&&c.subtype&&c.data){let a=c.subtype;if("fill_in_blanks"===a){let a=c.data?.blanks?.correct||[],b=0;for(let c=0;c<a.length;c++)(0,i.normalizeForComparison)(d[c]||"")===(0,i.normalizeForComparison)(a[c]||"")&&b++;let e=a.length>0&&b===a.length&&d.length===a.length;return{isCorrect:e,score:a.length?b/a.length:0,feedback:e?"All blanks correct!":`${b}/${a.length} blanks correct`}}if("translation"===a){let a=c.data?.tokens||[],b=d.join(" ").trim(),e=(c.data?.canonical_sentence||a.join(" ")).trim(),f=(0,i.normalizeForComparison)(b),g=(0,i.normalizeForComparison)(e),h=0,j=Math.min(d.length,a.length);for(let b=0;b<j;b++)(0,i.normalizeForComparison)(d[b]||"")===(0,i.normalizeForComparison)(a[b]||"")&&h++;let k=a.length>0&&d.length===a.length&&f===g;return{isCorrect:k,score:a.length?h/a.length:0,feedback:k?"Perfect translation!":`${h}/${a.length} tokens in correct order`}}{let a=c.data?.tokens||[],b=0,e=Math.min(d.length,a.length);for(let c=0;c<e;c++)(0,i.normalizeForComparison)(d[c]||"")===(0,i.normalizeForComparison)(a[c]||"")&&b++;let f=a.length>0&&d.length===a.length&&b===a.length;return{isCorrect:f,score:a.length?b/a.length:0,feedback:f?"Perfect sentence!":`${b}/${a.length} tokens in correct order`}}}let e=a.correctAnswer||[],f=0;for(let a of d){let b=(0,i.normalizeForComparison)(a);e.some(a=>(0,i.normalizeForComparison)(a)===b)&&f++}let g=e.length>0&&f===e.length&&d.length===e.length;return{isCorrect:g,score:e.length?f/e.length:0,feedback:g?"Perfect translation!":`${f}/${e.length||0} words correct`}}case"error-correction":{let c=(0,i.normalizeForComparison)(b||"")===(0,i.normalizeForComparison)(a.target);return{isCorrect:c,score:+!!c,feedback:c?"Correct correction!":`The correct sentence is: "${a.target}"`}}case"grammar-structure":{let c=b===a.correctChoiceId;return{isCorrect:c,score:+!!c,feedback:c?"Correct grammar!":`Incorrect. ${a.hint||"Please review the grammar rule."}`}}case"dialogue-completion":{let c=b===a.correctChoiceId;return{isCorrect:c,score:+!!c,feedback:c?"Good dialogue completion!":"Try a more appropriate response"}}case"role-play":{let c=b||[],d=a.steps.length,e=a.steps.filter((a,b)=>c[b]===a.expected).length,f=e/d,g=f>.5;return{isCorrect:g,score:f,feedback:g?`Great role-play! ${e}/${d} steps correct (${Math.round(100*f)}% accuracy)`:`${e}/${d} steps correct (${Math.round(100*f)}% accuracy). Try to get more than 50% correct next time!`}}default:return{isCorrect:!1,score:0,feedback:"Unknown question type"}}}function l(a,b){return`exercise:${a}:${b||"default"}:${j}`}function m(a,b,c){try{let d=l(a,b),e=n(a,b),f={exerciseId:a,version:j,status:"in_progress",startedAt:Date.now(),currentQuestionIndex:0,attempts:[],progress:{currentQuestionIndex:0,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1},...e,...c,lastUpdatedAt:Date.now()};localStorage.setItem(d,JSON.stringify(f))}catch(a){console.warn("Failed to save exercise session:",a)}}function n(a,b){try{let c=l(a,b),d=localStorage.getItem(c);if(!d)return null;let e=JSON.parse(d);if(e.version!==j)return console.warn("Exercise session version mismatch, starting fresh"),null;return e}catch(a){return console.warn("Failed to load exercise session:",a),null}}function o(a,b){try{let c=l(a,b);localStorage.removeItem(c)}catch(a){console.warn("Failed to clear exercise session:",a)}}function p(a,b,c){let d=n(a,b);d&&(d.attempts=d.attempts.filter(a=>a.questionId!==c.questionId),d.attempts.push(c),m(a,b,d))}function q(a,b,c){let d=n(a,b);return d&&d.attempts.find(a=>a.questionId===c)||null}function r(a){let b=a.correctAnswers+a.incorrectAnswers;return b>0?Math.round(a.correctAnswers/b*100):0}function s(a,b,c){return void 0!==b?a>=b:void 0!==c?a>=(({1:65,2:70,3:75,4:80,5:85})[c]||80):a>=80}let t=(0,c.createContext)(void 0),u=({children:a,exerciseData:i,topicSlug:j,lessonSlug:l,urlQuestionIndex:u,onQuestionChange:v})=>{let[w,x]=(0,c.useState)(null),[y,z]=(0,c.useState)({currentQuestionIndex:0,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1}),[A,B]=(0,c.useState)(null),[C,D]=(0,c.useState)(!1),[E,F]=(0,c.useState)(null),[G,H]=(0,c.useState)(Date.now()),[I,J]=(0,c.useState)(!1),[K,L]=(0,c.useState)("main"),[M,N]=(0,c.useState)([]),[O,P]=(0,c.useState)({}),[Q,R]=(0,c.useState)(!1),{toast:S}=(0,d.useToast)(),{playSound:T}={playSound:(0,c.useCallback)(a=>{try{let b=new Audio(`/sounds/${a}`);b.volume=.6,b.play().catch(a=>{console.debug("Sound play failed:",a)})}catch(a){console.debug("Sound utility error:",a)}},[])},{startExercise:U,submitExercise:V,checkForResume:W}=(0,e.useExerciseSession)(),X=(0,f.useQueryClient)(),{user:Y}=(0,h.useUserProfile)(),Z=(0,c.useRef)(!1),$=(0,c.useRef)(!1),_=(0,c.useRef)(null);(0,c.useEffect)(()=>{i&&!Z.current&&(async()=>{try{if(!i.id){console.error("[ExerciseContext] Invalid exercise data - missing id:",i),S({title:"Error",description:"Invalid exercise data. Please refresh the page.",variant:"destructive"});return}let a=n(i.id,l),b=await W(i.id);if(b){console.log("[ExerciseContext] Resuming from API session:",b.practiceResultId),_.current=b.practiceResultId;let c=a?Math.min(a.currentQuestionIndex,i.questions.length-1):0;x(i),z(a?.progress||{currentQuestionIndex:c,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1}),L(a?.phase||"main"),N(a?.skippedQueueIds||[]),P(a?.skipCounts||{})}else{console.error("[ExerciseContext] No active session found - redirecting to lesson page"),S({title:"No Active Session",description:"Please start the exercise from the lesson page.",variant:"destructive"}),window.location.href=`/learn/${j}/${l}`;return}Z.current=!0}catch(a){console.error("[ExerciseContext] Error initializing session:",a),S({title:"Initialization Error",description:"Could not initialize exercise. Please try again.",variant:"destructive"})}})()},[i,l,W,U,S]),(0,c.useEffect)(()=>{if(!w||u<0||u>=w.questions.length)return;let a=w.questions[u];if(!a)return;let b=q(w.id,l,a.id);z(a=>({...a,currentQuestionIndex:u})),B(b?.userAnswer||null),D(!!b),F(b?.grade||null),H(Date.now())},[u,w,l]),(0,c.useEffect)(()=>{if(console.log("[ExerciseContext] Completion check:",{pendingResultSave:Q,isSaving:$.current,hasExercise:!!w,completed:y.completed,hasEndTime:!!y.endTime}),!Q||$.current||!w||!y.completed||!y.endTime)return;let a=!1;return $.current=!0,(async()=>{if(console.log("[ExerciseContext] Starting handleCompletion"),!_.current){console.error("[ExerciseContext] No practice result ID found, cannot save results"),S({title:"Session Error",description:"Exercise session not found. Your progress may not be saved.",variant:"destructive"});return}let a=n(w.id,l),b=a?.attempts||[],c=w.questions.length,d=y.correctAnswers/c*100,e=c-y.correctAnswers-y.incorrectAnswers,f=Math.floor((y.endTime-y.startTime)/1e3),h=Math.round((y.endTime-y.startTime)/6e4),i=r(y),j=s(i,void 0,w.zoneLevel);console.log("[ExerciseContext] Exercise metrics:",{practiceResultId:_.current,totalQuestions:c,scorePercent:d,totalSkipped:e,timeSpentSeconds:f,studyTimeMinutes:h,accuracy:i,passed:j,attemptsCount:b.length});let k=await V({practiceResultId:_.current,practiceSetId:w.id,scorePercent:d,totalCorrect:y.correctAnswers,totalIncorrect:y.incorrectAnswers,totalSkipped:e,timeSpentSeconds:f,passed:j,attempts:b});if(!k){console.error("[ExerciseContext] Failed to submit exercise results to API"),S({title:"Save Failed",description:"Your progress could not be saved. Please try again.",variant:"destructive"});return}if(console.log("[ExerciseContext] Exercise result submitted successfully:",k),Y?.id&&k.topicId&&k.lessonId){console.log("[ExerciseContext] Applying optimistic update and invalidating cache for topic:",k.topicId);let a=k.topicId,b=k.lessonId,c=g.queryKeys.lessonProgress.topic(Y.id,a);X.getQueryData(c),X.setQueryData(c,c=>{if(!c||!Array.isArray(c))return c;let e=c.findIndex(a=>a.lesson_id===b);if(!(e>=0))return[...c,{lesson_id:b,topic_id:a,best_score_percent:d,total_attempts:1,status:j?"passed":"in_progress",last_attempted_at:new Date().toISOString(),passed_at:j?new Date().toISOString():null}];{let a=[...c];return a[e]={...a[e],best_score_percent:Math.max(d,a[e].best_score_percent||0),total_attempts:(a[e].total_attempts||0)+1,status:j?"passed":"in_progress",last_attempted_at:new Date().toISOString(),passed_at:j?new Date().toISOString():a[e].passed_at},a}}),X.invalidateQueries({queryKey:g.queryKeys.lessonProgress.topic(Y.id,a)}),X.invalidateQueries({queryKey:g.queryKeys.user.progress()}),X.invalidateQueries({queryKey:g.queryKeys.quests.progress()})}o(w.id,l),_.current=null;let m=k.isFirstPass?`Earned ${k.coinsEarned} coins and ${k.xpEarned} XP!`:"Keep practicing to improve!";S({title:"Exercise Completed!",description:`Accuracy: ${i}%. ${j?"Passed!":"Try again to improve."} ${m}`,variant:j?"default":"destructive"})})().finally(()=>{$.current=!1,a||R(!1)}),()=>{a=!0}},[Q,w,y.completed,y.endTime,y.correctAnswers,y.incorrectAnswers,y.startTime,l,S,V,X,Y?.id]);let aa=(0,c.useCallback)((a,b,c)=>{x(a);let d=n(a.id,c);if(d)z(d.progress),setTimeout(()=>v(d.currentQuestionIndex),0);else{let b={currentQuestionIndex:0,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1};z(b),m(a.id,c,{status:"in_progress",currentQuestionIndex:0,progress:b}),setTimeout(()=>v(0),0)}B(null),D(!1),F(null),H(Date.now()),R(!1)},[v]),ab=(0,c.useCallback)(()=>{if(!w||!w.questions[y.currentQuestionIndex]||C)return;let a=w.questions[y.currentQuestionIndex],b=Date.now()-G,c=k(a,A);c.isCorrect?T("correct.mp3"):T("incorrect.wav");let d={questionId:a.id,userAnswer:A,grade:c,timeSpentMs:b,timestamp:Date.now(),questionType:a.type};p(w.id,l,d);let e={...y,correctAnswers:y.correctAnswers+ +!!c.isCorrect,incorrectAnswers:y.incorrectAnswers+ +!c.isCorrect};if(z(e),"skipped"===K){let b=a.id;if(M.includes(b)){let a=M.filter(a=>a!==b);N(a),m(w.id,l,{skippedQueueIds:a,skipCounts:O,phase:K})}}m(w.id,l,{currentQuestionIndex:y.currentQuestionIndex,progress:e}),D(!0),F(c)},[w,A,C,G,y,l,K,M,O,T]),ac=(0,c.useCallback)(()=>{if(!w)return;let a=w.questions.length;if("main"===K){let b=y.currentQuestionIndex+1;if(b>=a){if(M.length>0){L("skipped"),m(w.id,l,{phase:"skipped"});let a=M[0],b=w.questions.findIndex(b=>b.id===a);b>=0&&setTimeout(()=>v(b),0);return}let a=Date.now();z({...y,endTime:a,completed:!0}),R(!0);return}setTimeout(()=>v(b),0);return}let b=w.questions[y.currentQuestionIndex]?.id,c=b?M.indexOf(b):-1,d=c>=0?c+1:0;if(d<M.length){let a=M[d],b=w.questions.findIndex(b=>b.id===a);b>=0&&setTimeout(()=>v(b),0);return}let e=Date.now();z({...y,endTime:e,completed:!0}),R(!0)},[w,v,K,y,M]),ad=(0,c.useCallback)(()=>{if(!w)return;let a=w.questions[y.currentQuestionIndex];if(!a)return;T("flip.mp3");let b=a.id;P(a=>{let c=(a[b]||0)+1,d={...a,[b]:c};return m(w.id,l,{skipCounts:d,skippedQueueIds:M,phase:K}),d});let c=(O[b]||0)+1;if(c>=3){let d={questionId:b,userAnswer:null,grade:{isCorrect:!1,score:0,feedback:"Marked incorrect after 3 skips"},timeSpentMs:Date.now()-G,timestamp:Date.now(),status:"skipped",questionType:a.type};p(w.id,l,d);let e={...y,incorrectAnswers:y.incorrectAnswers+1};z(e);let f=M.indexOf(b),g=M;if(f>=0&&N(g=[...M.slice(0,f),...M.slice(f+1)]),m(w.id,l,{skippedQueueIds:g,skipCounts:{...O,[b]:c},progress:e,phase:K}),"main"===K){let a=y.currentQuestionIndex+1;if(a<w.questions.length)return void setTimeout(()=>v(a),0);if(g.length>0){L("skipped");let a=g[0],b=w.questions.findIndex(b=>b.id===a);b>=0&&setTimeout(()=>v(b),0);return}let b=Date.now();return z({...e,endTime:b,completed:!0}),void R(!0)}{let a=M.indexOf(b),c=a>=0&&a<g.length?g[a]:g[0];if(c){let a=w.questions.findIndex(a=>a.id===c);a>=0&&setTimeout(()=>v(a),0);return}let d=Date.now();z({...e,endTime:d,completed:!0}),R(!0);return}}if("main"===K){let a=M.includes(b)?M:[...M,b];a!==M?(N(a),m(w.id,l,{skippedQueueIds:a,skipCounts:{...O,[b]:c},phase:K})):m(w.id,l,{skipCounts:{...O,[b]:c},phase:K});let d=y.currentQuestionIndex+1;if(d<w.questions.length)return void setTimeout(()=>v(d),0);if(a.length>0){L("skipped"),m(w.id,l,{phase:"skipped"});let b=a[0],c=w.questions.findIndex(a=>a.id===b);c>=0&&setTimeout(()=>v(c),0);return}let e=Date.now();return z({...y,endTime:e,completed:!0}),void R(!0)}{let a=M.indexOf(b);if(a>=0){let d=[...M.slice(0,a),...M.slice(a+1),b];N(d),m(w.id,l,{skippedQueueIds:d,skipCounts:{...O,[b]:c},phase:K});let e=d[a];if(e&&e!==b){let a=w.questions.findIndex(a=>a.id===e);a>=0&&setTimeout(()=>v(a),0)}}}},[w,l,v,K,y,G,O,M,T]),ae=(0,c.useCallback)(()=>{if(y.currentQuestionIndex<=0)return;let a=y.currentQuestionIndex-1;setTimeout(()=>v(a),0)},[y.currentQuestionIndex,v]),af=(0,c.useCallback)(a=>{!w||a<0||a>=w.questions.length||setTimeout(()=>v(a),0)},[w,v]),ag=(0,c.useCallback)(()=>{if(!w)return;let a=Date.now(),b={...y,endTime:a,completed:!0};console.log("[ExerciseContext] completeExercise called",{exerciseId:w.id,progress:b}),z(b),R(!0)},[w,y]),ah=(0,c.useCallback)(async()=>{if(!w)return;o(w.id,l),Z.current=!1,_.current=null;let a=await U(w.id);a&&(_.current=a.practiceResultId,console.log("[ExerciseContext] New session created on reset:",_.current)),z({currentQuestionIndex:0,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1}),B(null),D(!1),F(null),H(Date.now()),J(!1),L("main"),N([]),P({}),R(!1),setTimeout(()=>v(0),0)},[w,l,v,U]),ai=(0,c.useCallback)(()=>{J(a=>!a)},[]),aj=w?w.questions[y.currentQuestionIndex]:null,ak=y.currentQuestionIndex,al=!!w&&ak===w.questions.length-1,am=(0,c.useCallback)(a=>w?q(w.id,l,a):null,[w,l]);return(0,b.jsx)(t.Provider,{value:{exercise:w,progress:y,currentQuestion:aj,currentQuestionIndex:ak,isLastQuestion:al,isFirstQuestion:0===ak,questionStartTime:G,userAnswer:A,isAnswered:C,gradeResult:E,setUserAnswer:B,submitAnswer:ab,skipQuestion:ad,nextQuestion:ac,previousQuestion:ae,jumpToQuestion:af,completeExercise:ag,resetExercise:ah,startExercise:aa,reviewMode:I,toggleReviewMode:ai,getQuestionAttempt:am},children:a})},v=()=>{let a=(0,c.useContext)(t);if(void 0===a)throw Error("useExercise must be used within an ExerciseProvider");return a}}];

//# sourceMappingURL=features_learn_contexts_ExerciseContext_tsx_216a01f9._.js.map