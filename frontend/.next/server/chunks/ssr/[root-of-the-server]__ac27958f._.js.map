{"version":3,"sources":["turbopack:///[project]/features/flashcards/utils/vocab-key.ts","turbopack:///[project]/features/flashcards/components/review/ReviewClient.tsx/__nextjs-internal-proxy.mjs","turbopack:///[project]/app/(app)/flashcards/review/page.tsx","turbopack:///[project]/.next-internal/server/app/(app)/flashcards/review/page/actions.js (server actions loader)","turbopack:///[project]/features/flashcards/actions/review.ts"],"sourcesContent":["/**\r\n * Utility functions for generating and parsing deterministic vocabulary keys\r\n * Format: t{topicId}-l{lessonId}-{slugified_vietnamese}\r\n */\r\n\r\n/**\r\n * Generates a deterministic vocabulary key from topic, lesson, and Vietnamese text\r\n * @param topicId - Topic ID (bigint)\r\n * @param lessonId - Lesson ID (bigint)\r\n * @param vietnameseText - Vietnamese text to slugify\r\n * @returns Deterministic key in format: t{topicId}-l{lessonId}-{slugified}\r\n */\r\nexport function generateVocabKey(\r\n  topicId: number,\r\n  lessonId: number,\r\n  vietnameseText: string\r\n): string {\r\n  const slugified = vietnameseText\r\n    .toLowerCase()\r\n    .trim()\r\n    .replace(/\\s+/g, '_')\r\n    .replace(/[^\\w\\-_]/g, '')\r\n    .replace(/_+/g, '_') // Replace multiple underscores with single\r\n    .replace(/^_|_$/g, ''); // Remove leading/trailing underscores\r\n\r\n  return `t${topicId}-l${lessonId}-${slugified}`;\r\n}\r\n\r\n/**\r\n * Parses a vocabulary key to extract topic ID, lesson ID, and slug\r\n * @param key - Vocabulary key in format: t{topicId}-l{lessonId}-{slug}\r\n * @returns Parsed components or null if invalid format\r\n */\r\nexport function parseVocabKey(\r\n  key: string\r\n): { topicId: number; lessonId: number; slug: string } | null {\r\n  const match = key.match(/^t(\\d+)-l(\\d+)-(.+)$/);\r\n  if (!match) return null;\r\n\r\n  return {\r\n    topicId: parseInt(match[1], 10),\r\n    lessonId: parseInt(match[2], 10),\r\n    slug: match[3],\r\n  };\r\n}\r\n\r\n/**\r\n * Checks if a string is a valid vocabulary key format\r\n * @param key - String to validate\r\n * @returns True if key matches vocabulary key format\r\n */\r\nexport function isValidVocabKey(key: string): boolean {\r\n  return /^t\\d+-l\\d+-[\\w\\-_]+$/.test(key);\r\n}\r\n\r\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/features/flashcards/components/review/ReviewClient.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/features/flashcards/components/review/ReviewClient.tsx\",\n    \"default\",\n);\n","import { Suspense } from 'react'\r\nimport ReviewClient from '@/features/flashcards/components/review/ReviewClient'\r\n\r\nexport default function ReviewPage() {\r\n  return (\r\n    <Suspense fallback={\r\n      <div className=\"container mx-auto py-10 px-4 max-w-4xl\">\r\n        {/* Header Skeleton */}\r\n        <div className=\"text-center mb-8\">\r\n          <div className=\"h-8 bg-gray-200 dark:bg-gray-700 rounded w-64 mb-2 animate-pulse mx-auto\"></div>\r\n          <div className=\"h-4 bg-gray-200 dark:bg-gray-700 rounded w-96 animate-pulse mx-auto\"></div>\r\n        </div>\r\n\r\n        {/* Review Card Skeleton */}\r\n        <div className=\"h-96 bg-gray-200 dark:bg-gray-700 rounded mb-8 animate-pulse\"></div>\r\n\r\n        {/* Buttons Skeleton */}\r\n        <div className=\"flex justify-center gap-4 mb-8\">\r\n          <div className=\"h-10 bg-gray-200 dark:bg-gray-700 rounded w-48 animate-pulse\"></div>\r\n        </div>\r\n\r\n        {/* Separator */}\r\n        <div className=\"h-px bg-gray-200 dark:bg-gray-700 mb-8\"></div>\r\n\r\n        {/* Session Config Skeleton */}\r\n        <div className=\"h-96 bg-gray-200 dark:bg-gray-700 rounded mb-8 animate-pulse\"></div>\r\n\r\n        {/* Start Button Skeleton */}\r\n        <div className=\"text-center mb-8\">\r\n          <div className=\"h-14 bg-gray-200 dark:bg-gray-700 rounded w-64 animate-pulse mx-auto\"></div>\r\n        </div>\r\n      </div>\r\n    }>\r\n      <ReviewClient />\r\n    </Suspense>\r\n  )\r\n}\r\n","export {saveVocabularyFromLesson as '40b7874b5beee18e2e913212052e9efd3061f9459a'} from 'ACTIONS_MODULE0'\nexport {unsaveVocabularyFromLesson as '40a12d3392f5f7e3fd35f464eebcfef7da83f3293b'} from 'ACTIONS_MODULE1'\nexport {createReviewSession as '40138ba5c927606e17947caf045f883ea82b7072d9'} from 'ACTIONS_MODULE2'\nexport {createSessionCardMappings as '4066c3bfc9842b3e7a2fa482e6d40eb90f4e658ba3'} from 'ACTIONS_MODULE2'\n","'use server'\n\nimport { createClient, isSupabaseConfigured } from '@/shared/lib/supabase/server'\nimport { revalidatePath } from 'next/cache'\n\n/**\n * Input for creating a review session\n */\nexport interface CreateReviewSessionInput {\n  session_type: 'daily' | 'custom'\n  total_cards: number\n  session_config?: Record<string, unknown>\n  filters_applied?: Record<string, unknown>\n}\n\n/**\n * Result from creating a review session\n */\nexport interface CreateReviewSessionResult {\n  success: boolean\n  data?: {\n    id: string\n    user_id: string\n    session_type: string\n    total_cards: number\n    created_at: string\n  }\n  error?: string\n}\n\n/**\n * Input for creating session card mappings\n */\nexport interface CreateSessionCardMappingsInput {\n  session_id: string\n  flashcards: Array<{\n    id?: string\n    _id?: string\n    [key: string]: unknown\n  }>\n}\n\n/**\n * Result from creating session card mappings\n */\nexport interface CreateSessionCardMappingsResult {\n  success: boolean\n  data?: {\n    inserted_count: number\n    failed_count: number\n  }\n  error?: string\n}\n\n/**\n * Server action to create a review session\n * Uses server-side Supabase client to avoid cookie conflicts\n */\nexport async function createReviewSession(\n  input: CreateReviewSessionInput\n): Promise<CreateReviewSessionResult> {\n  try {\n    console.log('üíæ [Server Action] createReviewSession called:', input)\n\n    // Early return if Supabase is not configured\n    if (!isSupabaseConfigured) {\n      return {\n        success: false,\n        error: 'Supabase is not configured'\n      }\n    }\n\n    // Get server-side Supabase client with fresh session\n    const supabase = await createClient()\n\n    // Verify user is authenticated\n    const { data: { user }, error: userError } = await supabase.auth.getUser()\n\n    console.log('üë§ [Server Action] User authentication:', {\n      authenticated: !!user,\n      userId: user?.id\n    })\n\n    if (userError || !user) {\n      return {\n        success: false,\n        error: 'Not authenticated - please log in first'\n      }\n    }\n\n    // Prepare session data to match database schema\n    const sessionData = {\n      user_id: user.id,\n      session_type: input.session_type,\n      total_cards: input.total_cards,\n      session_config: input.session_config || {},\n      filters_applied: input.filters_applied || {}\n    }\n\n    console.log('üíæ [Server Action] Inserting session data:', sessionData)\n\n    // Insert session into database\n    // Use server-side client which uses HttpOnly cookies\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const supabaseAny = supabase as any\n    const { data: sessionResult, error: insertError } = await supabaseAny\n      .from('review_sessions')\n      .insert(sessionData)\n      .select()\n      .single()\n\n    if (insertError) {\n      console.error('‚ùå [Server Action] Database insert error:', insertError)\n      return {\n        success: false,\n        error: insertError.message || 'Failed to create session'\n      }\n    }\n\n    if (!sessionResult) {\n      return {\n        success: false,\n        error: 'Failed to create session - no data returned'\n      }\n    }\n\n    console.log('‚úÖ [Server Action] Session created successfully:', sessionResult.id)\n\n    // Revalidate review pages\n    revalidatePath('/flashcards/review')\n\n    return {\n      success: true,\n      data: {\n        id: sessionResult.id,\n        user_id: sessionResult.user_id,\n        session_type: sessionResult.session_type,\n        total_cards: sessionResult.total_cards,\n        created_at: sessionResult.created_at\n      }\n    }\n  } catch (error) {\n    console.error('‚ùå [Server Action] Error creating session:', error)\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Failed to create session'\n    }\n  }\n}\n\n/**\n * Server action to create session card mappings\n * Maps flashcards to a review session\n */\nexport async function createSessionCardMappings(\n  input: CreateSessionCardMappingsInput\n): Promise<CreateSessionCardMappingsResult> {\n  try {\n    console.log('üìù [Server Action] createSessionCardMappings called:', {\n      session_id: input.session_id,\n      flashcard_count: input.flashcards.length\n    })\n\n    // Early return if Supabase is not configured\n    if (!isSupabaseConfigured) {\n      return {\n        success: false,\n        error: 'Supabase is not configured'\n      }\n    }\n\n    // Get server-side Supabase client with fresh session\n    const supabase = await createClient()\n\n    // Verify user is authenticated\n    const { data: { user }, error: userError } = await supabase.auth.getUser()\n\n    if (userError || !user) {\n      return {\n        success: false,\n        error: 'Not authenticated - please log in first'\n      }\n    }\n\n    // Prepare rows for insertion\n    const rows = input.flashcards.map((fc, idx) => {\n      // Backend returns FlashcardResponse objects, extract the ID\n      const flashcardId = typeof fc === 'string' ? fc : (fc?.id ?? fc?._id ?? '')\n      return {\n        session_id: input.session_id,\n        flashcard_id: flashcardId,\n        flashcard_type: 'APP' as const,\n        card_order: idx + 1\n      }\n    }).filter(r => r.flashcard_id) // Only include valid flashcard IDs\n\n    console.log(`üìù [Server Action] Inserting ${rows.length} session card mappings`)\n\n    // Insert in batches to avoid payload limits\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const supabaseAny = supabase as any\n    const batchSize = 100\n    let insertedCount = 0\n    let failedCount = 0\n\n    for (let i = 0; i < rows.length; i += batchSize) {\n      const batch = rows.slice(i, i + batchSize)\n      const { error: mapErr } = await supabaseAny\n        .from('review_session_cards')\n        .insert(batch)\n\n      if (mapErr) {\n        console.error(`‚ùå [Server Action] Error inserting batch ${i / batchSize + 1}:`, mapErr)\n        failedCount += batch.length\n      } else {\n        insertedCount += batch.length\n        console.log(`‚úÖ [Server Action] Inserted batch ${i / batchSize + 1} (${batch.length} cards)`)\n      }\n    }\n\n    console.log(`‚úÖ [Server Action] Total cards mapped: ${insertedCount}/${rows.length}`)\n\n    // Revalidate review pages\n    revalidatePath('/flashcards/review')\n\n    return {\n      success: true,\n      data: {\n        inserted_count: insertedCount,\n        failed_count: failedCount\n      }\n    }\n  } catch (error) {\n    console.error('‚ùå [Server Action] Error creating session card mappings:', error)\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Failed to create session card mappings'\n    }\n  }\n}\n"],"names":[],"mappings":"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","ignoreList":[1]}