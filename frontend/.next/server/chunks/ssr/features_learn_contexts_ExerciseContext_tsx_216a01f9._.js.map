{"version":3,"sources":["turbopack:///[project]/features/learn/contexts/ExerciseContext.tsx","turbopack:///[project]/shared/hooks/useSound.ts","turbopack:///[project]/features/learn/utils/exercise-utils.ts"],"sourcesContent":["\"use client\"\r\n\r\nimport { createContext, useContext, useState, useCallback, useEffect, useRef, type ReactNode } from \"react\"\r\nimport type { Exercise, ExerciseProgress, Question } from \"@/features/learn/types/practice\"\r\nimport { useToast } from \"@/shared/hooks/use-toast\"\r\nimport { useSound } from \"@/shared/hooks/useSound\"\r\nimport { useExerciseSession } from \"@/features/learn/hooks/use-exercise-session\"\r\nimport { useQueryClient } from '@tanstack/react-query'\r\nimport { queryKeys } from '@/shared/hooks/query-keys'\r\nimport { useUserProfile } from '@/shared/hooks/use-user-profile'\r\nimport {\r\n  saveExerciseSession,\r\n  loadExerciseSession,\r\n  clearExerciseSession,\r\n  saveQuestionAttempt,\r\n  getQuestionAttempt,\r\n  gradeQuestion,\r\n  calculateAccuracy,\r\n  isExercisePassed,\r\n  type QuestionAttempt,\r\n  type GradeResult\r\n} from \"@/features/learn/utils/exercise-utils\"\r\n\r\ninterface ExerciseContextType {\r\n  exercise: Exercise | null\r\n  progress: ExerciseProgress\r\n  currentQuestion: Question | null\r\n  currentQuestionIndex: number\r\n  isLastQuestion: boolean\r\n  isFirstQuestion: boolean\r\n  questionStartTime: number\r\n  userAnswer: any\r\n  isAnswered: boolean\r\n  gradeResult: GradeResult | null\r\n\r\n  // Actions\r\n  setUserAnswer: (answer: any) => void\r\n  submitAnswer: () => void\r\n  skipQuestion: () => void\r\n  nextQuestion: () => void\r\n  previousQuestion: () => void\r\n  jumpToQuestion: (index: number) => void\r\n  completeExercise: () => void\r\n  resetExercise: () => void\r\n  startExercise: (exercise: Exercise, topicSlug: string, lessonSlug: string) => void\r\n\r\n  // Review mode\r\n  reviewMode: boolean\r\n  toggleReviewMode: () => void\r\n  getQuestionAttempt: (questionId: string) => QuestionAttempt | null\r\n}\r\n\r\nconst ExerciseContext = createContext<ExerciseContextType | undefined>(undefined)\r\n\r\ninterface ExerciseProviderProps {\r\n  children: ReactNode\r\n  exerciseData: Exercise | null\r\n  topicSlug: string\r\n  lessonSlug: string\r\n  urlQuestionIndex: number\r\n  onQuestionChange: (index: number) => void\r\n}\r\n\r\nexport const ExerciseProvider = ({\r\n  children,\r\n  exerciseData,\r\n  topicSlug,\r\n  lessonSlug,\r\n  urlQuestionIndex,\r\n  onQuestionChange\r\n}: ExerciseProviderProps) => {\r\n  const [exercise, setExercise] = useState<Exercise | null>(null)\r\n  const [progress, setProgress] = useState<ExerciseProgress>({\r\n    currentQuestionIndex: 0,\r\n    correctAnswers: 0,\r\n    incorrectAnswers: 0,\r\n    startTime: Date.now(),\r\n    completed: false,\r\n  })\r\n  const [userAnswer, setUserAnswer] = useState<any>(null)\r\n  const [isAnswered, setIsAnswered] = useState(false)\r\n  const [gradeResult, setGradeResult] = useState<GradeResult | null>(null)\r\n  const [questionStartTime, setQuestionStartTime] = useState(Date.now())\r\n  const [reviewMode, setReviewMode] = useState(false)\r\n  // Skip management state\r\n  const [phase, setPhase] = useState<\"main\" | \"skipped\">(\"main\")\r\n  const [skippedQueueIds, setSkippedQueueIds] = useState<string[]>([])\r\n  const [skipCounts, setSkipCounts] = useState<Record<string, number>>({})\r\n  const [pendingResultSave, setPendingResultSave] = useState(false)\r\n\r\n  const { toast } = useToast()\r\n  const { playSound } = useSound()\r\n  const {\r\n    startExercise: startApiSession,\r\n    submitExercise: submitApiSession,\r\n    checkForResume: checkApiResume\r\n  } = useExerciseSession()\r\n  const queryClient = useQueryClient()\r\n  const { user } = useUserProfile()\r\n  const initialized = useRef(false)\r\n  const isSavingResult = useRef(false)\r\n  const practiceResultId = useRef<string | null>(null)\r\n\r\n  // Initialize exercise from data and API session\r\n  useEffect(() => {\r\n    if (!exerciseData || initialized.current) return\r\n\r\n    const initializeSession = async () => {\r\n      try {\r\n        // Validate exercise data\r\n        if (!exerciseData.id) {\r\n          console.error('[ExerciseContext] Invalid exercise data - missing id:', exerciseData)\r\n          toast({\r\n            title: \"Error\",\r\n            description: \"Invalid exercise data. Please refresh the page.\",\r\n            variant: \"destructive\"\r\n          })\r\n          return\r\n        }\r\n\r\n        // First, check localStorage for local session state\r\n        const localSession = loadExerciseSession(exerciseData.id, lessonSlug)\r\n        \r\n        // Then check for an existing in_progress session from API\r\n        const apiSession = await checkApiResume(exerciseData.id)\r\n        \r\n        if (apiSession) {\r\n          // Resume from API session\r\n          console.log('[ExerciseContext] Resuming from API session:', apiSession.practiceResultId)\r\n          practiceResultId.current = apiSession.practiceResultId\r\n\r\n          const resumeIndex = localSession\r\n            ? Math.min(localSession.currentQuestionIndex, exerciseData.questions.length - 1)\r\n            : 0\r\n\r\n          setExercise(exerciseData)\r\n          setProgress(localSession?.progress || {\r\n            currentQuestionIndex: resumeIndex,\r\n            correctAnswers: 0,\r\n            incorrectAnswers: 0,\r\n            startTime: Date.now(),\r\n            completed: false,\r\n          })\r\n          setPhase((localSession?.phase as any) || \"main\")\r\n          setSkippedQueueIds(localSession?.skippedQueueIds || [])\r\n          setSkipCounts(localSession?.skipCounts || {})\r\n        } else {\r\n          // No active session found - redirect back to lesson page\r\n          // Session should have been created via button click before navigation\r\n          console.error('[ExerciseContext] No active session found - redirecting to lesson page')\r\n          toast({\r\n            title: \"No Active Session\",\r\n            description: \"Please start the exercise from the lesson page.\",\r\n            variant: \"destructive\"\r\n          })\r\n\r\n          // Redirect back to lesson page\r\n          window.location.href = `/learn/${topicSlug}/${lessonSlug}`\r\n          return\r\n        }\r\n\r\n        initialized.current = true\r\n      } catch (error) {\r\n        console.error('[ExerciseContext] Error initializing session:', error)\r\n        toast({\r\n          title: \"Initialization Error\",\r\n          description: \"Could not initialize exercise. Please try again.\",\r\n          variant: \"destructive\"\r\n        })\r\n      }\r\n    }\r\n\r\n    initializeSession()\r\n  }, [exerciseData, lessonSlug, checkApiResume, startApiSession, toast])\r\n\r\n  // Sync with URL question index\r\n  useEffect(() => {\r\n    if (!exercise || urlQuestionIndex < 0 || urlQuestionIndex >= exercise.questions.length) return\r\n\r\n    const currentQuestion = exercise.questions[urlQuestionIndex]\r\n    if (!currentQuestion) return // Safety check\r\n\r\n    const attempt = getQuestionAttempt(exercise.id, lessonSlug, currentQuestion.id)\r\n\r\n    setProgress(prev => ({ ...prev, currentQuestionIndex: urlQuestionIndex }))\r\n    setUserAnswer(attempt?.userAnswer || null)\r\n    setIsAnswered(!!attempt)\r\n    setGradeResult(attempt?.grade || null)\r\n    setQuestionStartTime(Date.now())\r\n  }, [urlQuestionIndex, exercise, lessonSlug])\r\n\r\n  // Handle completion when progress.completed changes\r\n  useEffect(() => {\r\n    // Debug: Log completion state\r\n    console.log('[ExerciseContext] Completion check:', {\r\n      pendingResultSave,\r\n      isSaving: isSavingResult.current,\r\n      hasExercise: !!exercise,\r\n      completed: progress.completed,\r\n      hasEndTime: !!progress.endTime,\r\n    })\r\n\r\n    if (\r\n      !pendingResultSave ||\r\n      isSavingResult.current ||\r\n      !exercise ||\r\n      !progress.completed ||\r\n      !progress.endTime\r\n    ) {\r\n      return\r\n    }\r\n\r\n    let cancelled = false\r\n    isSavingResult.current = true\r\n\r\n    const handleCompletion = async () => {\r\n      console.log('[ExerciseContext] Starting handleCompletion')\r\n      \r\n      if (!practiceResultId.current) {\r\n        console.error('[ExerciseContext] No practice result ID found, cannot save results')\r\n        toast({\r\n          title: \"Session Error\",\r\n          description: \"Exercise session not found. Your progress may not be saved.\",\r\n          variant: \"destructive\",\r\n        })\r\n        return\r\n      }\r\n\r\n      // Get all attempts from localStorage\r\n      const session = loadExerciseSession(exercise.id, lessonSlug)\r\n      const allAttempts = session?.attempts || []\r\n\r\n      // Calculate metrics\r\n      const totalQuestions = exercise.questions.length\r\n      const scorePercent = (progress.correctAnswers / totalQuestions) * 100\r\n      const totalSkipped = totalQuestions - progress.correctAnswers - progress.incorrectAnswers\r\n      const timeSpentSeconds = Math.floor((progress.endTime! - progress.startTime) / 1000)\r\n      const studyTimeMinutes = Math.round((progress.endTime! - progress.startTime) / (1000 * 60))\r\n      const accuracy = calculateAccuracy(progress)\r\n      const passed = isExercisePassed(accuracy, undefined, exercise.zoneLevel)\r\n\r\n      console.log('[ExerciseContext] Exercise metrics:', {\r\n        practiceResultId: practiceResultId.current,\r\n        totalQuestions,\r\n        scorePercent,\r\n        totalSkipped,\r\n        timeSpentSeconds,\r\n        studyTimeMinutes,\r\n        accuracy,\r\n        passed,\r\n        attemptsCount: allAttempts.length,\r\n      })\r\n\r\n      // Submit to API (send the attempts as-is, they already match QuestionAttempt type)\r\n      const submitResult = await submitApiSession({\r\n        practiceResultId: practiceResultId.current,\r\n        practiceSetId: exercise.id,\r\n        scorePercent,\r\n        totalCorrect: progress.correctAnswers,\r\n        totalIncorrect: progress.incorrectAnswers,\r\n        totalSkipped,\r\n        timeSpentSeconds,\r\n        passed,\r\n        attempts: allAttempts,\r\n      })\r\n\r\n      if (!submitResult) {\r\n        console.error('[ExerciseContext] Failed to submit exercise results to API')\r\n        toast({\r\n          title: \"Save Failed\",\r\n          description: \"Your progress could not be saved. Please try again.\",\r\n          variant: \"destructive\",\r\n        })\r\n        return\r\n      }\r\n\r\n      console.log('[ExerciseContext] Exercise result submitted successfully:', submitResult)\r\n\r\n      // ✅ OPTIMISTIC UPDATE + INVALIDATE CACHE\r\n      if (user?.id && (submitResult as any).topicId && (submitResult as any).lessonId) {\r\n        console.log('[ExerciseContext] Applying optimistic update and invalidating cache for topic:', (submitResult as any).topicId)\r\n        \r\n        const topicId = (submitResult as any).topicId\r\n        const lessonId = (submitResult as any).lessonId\r\n        \r\n        // Optimistic update: Cập nhật cache ngay lập tức\r\n        const queryKey = queryKeys.lessonProgress.topic(user.id, topicId)\r\n        const previousData = queryClient.getQueryData(queryKey)\r\n        \r\n        queryClient.setQueryData(queryKey, (old: any) => {\r\n          if (!old || !Array.isArray(old)) return old\r\n          \r\n          // Tìm lesson progress hiện tại hoặc tạo mới\r\n          const existingIndex = old.findIndex((p: any) => p.lesson_id === lessonId)\r\n          \r\n          if (existingIndex >= 0) {\r\n            // Update existing progress\r\n            const updated = [...old]\r\n            updated[existingIndex] = {\r\n              ...updated[existingIndex],\r\n              best_score_percent: Math.max(scorePercent, updated[existingIndex].best_score_percent || 0),\r\n              total_attempts: (updated[existingIndex].total_attempts || 0) + 1,\r\n              status: passed ? 'passed' : 'in_progress',\r\n              last_attempted_at: new Date().toISOString(),\r\n              passed_at: passed ? new Date().toISOString() : updated[existingIndex].passed_at,\r\n            }\r\n            return updated\r\n          } else {\r\n            // Add new progress\r\n            return [...old, {\r\n              lesson_id: lessonId,\r\n              topic_id: topicId,\r\n              best_score_percent: scorePercent,\r\n              total_attempts: 1,\r\n              status: passed ? 'passed' : 'in_progress',\r\n              last_attempted_at: new Date().toISOString(),\r\n              passed_at: passed ? new Date().toISOString() : null,\r\n            }]\r\n          }\r\n        })\r\n        \r\n        // Invalidate để refetch từ server (Realtime sẽ confirm sau)\r\n        queryClient.invalidateQueries({ \r\n          queryKey: queryKeys.lessonProgress.topic(user.id, topicId) \r\n        })\r\n        \r\n        // Invalidate user progress để cập nhật coins/XP\r\n        queryClient.invalidateQueries({ \r\n          queryKey: queryKeys.user.progress() \r\n        })\r\n        \r\n        // Invalidate quest progress\r\n        queryClient.invalidateQueries({ \r\n          queryKey: queryKeys.quests.progress() \r\n        })\r\n      }\r\n\r\n      // Clear localStorage session after successful save\r\n      clearExerciseSession(exercise.id, lessonSlug)\r\n      practiceResultId.current = null\r\n\r\n\r\n      // Show completion toast\r\n      const rewardText = submitResult.isFirstPass \r\n        ? `Earned ${submitResult.coinsEarned} coins and ${submitResult.xpEarned} XP!`\r\n        : 'Keep practicing to improve!'\r\n\r\n      toast({\r\n        title: \"Exercise Completed!\",\r\n        description: `Accuracy: ${accuracy}%. ${passed ? 'Passed!' : 'Try again to improve.'} ${rewardText}`,\r\n        variant: passed ? \"default\" : \"destructive\",\r\n      })\r\n    }\r\n\r\n    handleCompletion().finally(() => {\r\n      isSavingResult.current = false\r\n      if (!cancelled) {\r\n        setPendingResultSave(false)\r\n      }\r\n    })\r\n\r\n    return () => {\r\n      cancelled = true\r\n    }\r\n  }, [\r\n    pendingResultSave,\r\n    exercise,\r\n    progress.completed,\r\n    progress.endTime,\r\n    progress.correctAnswers,\r\n    progress.incorrectAnswers,\r\n    progress.startTime,\r\n    lessonSlug,\r\n    toast,\r\n    submitApiSession,\r\n    queryClient,\r\n    user?.id,\r\n  ])\r\n\r\n  const startExercise = useCallback((newExercise: Exercise, topicSlug: string, lessonSlug: string) => {\r\n    setExercise(newExercise)\r\n    const session = loadExerciseSession(newExercise.id, lessonSlug)\r\n\r\n    if (session) {\r\n      // Resume existing session\r\n      setProgress(session.progress)\r\n      // Schedule URL update after render\r\n      setTimeout(() => onQuestionChange(session.currentQuestionIndex), 0)\r\n    } else {\r\n      // Start new session\r\n      const initialProgress: ExerciseProgress = {\r\n        currentQuestionIndex: 0,\r\n        correctAnswers: 0,\r\n        incorrectAnswers: 0,\r\n        startTime: Date.now(),\r\n        completed: false,\r\n      }\r\n      setProgress(initialProgress)\r\n      saveExerciseSession(newExercise.id, lessonSlug, {\r\n        status: \"in_progress\",\r\n        currentQuestionIndex: 0,\r\n        progress: initialProgress,\r\n      })\r\n      // Schedule URL update after render\r\n      setTimeout(() => onQuestionChange(0), 0)\r\n    }\r\n\r\n    setUserAnswer(null)\r\n    setIsAnswered(false)\r\n    setGradeResult(null)\r\n    setQuestionStartTime(Date.now())\r\n    setPendingResultSave(false)\r\n  }, [onQuestionChange])\r\n\r\n  const submitAnswer = useCallback(() => {\r\n    if (!exercise || !exercise.questions[progress.currentQuestionIndex] || isAnswered) return\r\n\r\n    const currentQuestion = exercise.questions[progress.currentQuestionIndex]\r\n    const timeSpent = Date.now() - questionStartTime\r\n    const grade = gradeQuestion(currentQuestion, userAnswer)\r\n\r\n    // Play sound effect based on correctness\r\n    if (grade.isCorrect) {\r\n      playSound('correct.mp3')\r\n    } else {\r\n      playSound('incorrect.wav')\r\n    }\r\n\r\n    const attempt: QuestionAttempt = {\r\n      questionId: currentQuestion.id,\r\n      userAnswer,\r\n      grade,\r\n      timeSpentMs: timeSpent,\r\n      timestamp: Date.now(),\r\n      questionType: currentQuestion.type,\r\n    }\r\n\r\n    // Save attempt\r\n    saveQuestionAttempt(exercise.id, lessonSlug, attempt)\r\n\r\n    // Update progress\r\n    const newProgress = {\r\n      ...progress,\r\n      correctAnswers: progress.correctAnswers + (grade.isCorrect ? 1 : 0),\r\n      incorrectAnswers: progress.incorrectAnswers + (grade.isCorrect ? 0 : 1),\r\n    }\r\n    setProgress(newProgress)\r\n\r\n    // If we are in skipped phase and the question was in skipped queue, remove it\r\n    if (phase === \"skipped\") {\r\n      const qid = currentQuestion.id\r\n      if (skippedQueueIds.includes(qid)) {\r\n        const updated = skippedQueueIds.filter(id => id !== qid)\r\n        setSkippedQueueIds(updated)\r\n        // Persist queue update\r\n        saveExerciseSession(exercise.id, lessonSlug, {\r\n          skippedQueueIds: updated,\r\n          skipCounts,\r\n          phase,\r\n        } as any)\r\n      }\r\n    }\r\n\r\n    // Save session\r\n    saveExerciseSession(exercise.id, lessonSlug, {\r\n      currentQuestionIndex: progress.currentQuestionIndex,\r\n      progress: newProgress,\r\n    })\r\n\r\n    setIsAnswered(true)\r\n    setGradeResult(grade)\r\n  }, [exercise, userAnswer, isAnswered, questionStartTime, progress, lessonSlug, phase, skippedQueueIds, skipCounts, playSound])\r\n\r\n  const nextQuestion = useCallback(() => {\r\n    if (!exercise) return\r\n\r\n    const total = exercise.questions.length\r\n\r\n    if (phase === \"main\") {\r\n      const nextIndex = progress.currentQuestionIndex + 1\r\n      if (nextIndex >= total) {\r\n        // Main queue done. If we have skipped items, go to skipped phase.\r\n        if (skippedQueueIds.length > 0) {\r\n          setPhase(\"skipped\")\r\n          saveExerciseSession(exercise.id, lessonSlug, { phase: \"skipped\" } as any)\r\n          const firstId = skippedQueueIds[0]\r\n          const targetIdx = exercise.questions.findIndex(q => q.id === firstId)\r\n          if (targetIdx >= 0) setTimeout(() => onQuestionChange(targetIdx), 0)\r\n          return\r\n        }\r\n        // No skipped items, complete\r\n        const endTime = Date.now()\r\n        const finalProgress = {\r\n          ...progress,\r\n          endTime,\r\n          completed: true,\r\n        }\r\n        setProgress(finalProgress)\r\n        setPendingResultSave(true)\r\n        return\r\n      }\r\n      setTimeout(() => onQuestionChange(nextIndex), 0)\r\n      return\r\n    }\r\n\r\n    // Skipped phase\r\n    const currentId = exercise.questions[progress.currentQuestionIndex]?.id\r\n    const pos = currentId ? skippedQueueIds.indexOf(currentId) : -1\r\n    const nextPos = pos >= 0 ? pos + 1 : 0\r\n    if (nextPos < skippedQueueIds.length) {\r\n      const nextId = skippedQueueIds[nextPos]\r\n      const targetIdx = exercise.questions.findIndex(q => q.id === nextId)\r\n      if (targetIdx >= 0) setTimeout(() => onQuestionChange(targetIdx), 0)\r\n      return\r\n    }\r\n    // End of skipped queue → complete\r\n    const endTime = Date.now()\r\n    const finalProgress = {\r\n      ...progress,\r\n      endTime,\r\n      completed: true,\r\n    }\r\n    setProgress(finalProgress)\r\n    setPendingResultSave(true)\r\n  }, [exercise, onQuestionChange, phase, progress, skippedQueueIds])\r\n\r\n  const skipQuestion = useCallback(() => {\r\n    if (!exercise) return\r\n\r\n    const current = exercise.questions[progress.currentQuestionIndex]\r\n    if (!current) return\r\n\r\n    // Play skip sound effect\r\n    playSound('flip.mp3')\r\n\r\n    const qid = current.id\r\n\r\n    // Update skip count\r\n    setSkipCounts(prev => {\r\n      const nextCount = (prev[qid] || 0) + 1\r\n      const updated = { ...prev, [qid]: nextCount }\r\n\r\n      // Persist counts\r\n      saveExerciseSession(exercise.id, lessonSlug, {\r\n        skipCounts: updated,\r\n        skippedQueueIds,\r\n        phase,\r\n      } as any)\r\n      return updated\r\n    })\r\n\r\n    const currentSkipCount = (skipCounts[qid] || 0) + 1\r\n\r\n    // If third skip → mark incorrect and remove from queue, then advance\r\n    if (currentSkipCount >= 3) {\r\n      // Log an incorrect attempt due to multiple skips\r\n      const attempt: QuestionAttempt = {\r\n        questionId: qid,\r\n        userAnswer: null,\r\n        grade: { isCorrect: false, score: 0, feedback: \"Marked incorrect after 3 skips\" },\r\n        timeSpentMs: Date.now() - questionStartTime,\r\n        timestamp: Date.now(),\r\n        status: \"skipped\",\r\n        questionType: current.type,\r\n      }\r\n      saveQuestionAttempt(exercise.id, lessonSlug, attempt)\r\n\r\n      // Update progress (count as incorrect)\r\n      const newProgress = {\r\n        ...progress,\r\n        incorrectAnswers: progress.incorrectAnswers + 1,\r\n      }\r\n      setProgress(newProgress)\r\n\r\n      // Remove from skipped queue if present\r\n      const pos = skippedQueueIds.indexOf(qid)\r\n      let updatedQueue = skippedQueueIds\r\n      if (pos >= 0) {\r\n        updatedQueue = [...skippedQueueIds.slice(0, pos), ...skippedQueueIds.slice(pos + 1)]\r\n        setSkippedQueueIds(updatedQueue)\r\n      }\r\n      // Persist state\r\n      saveExerciseSession(exercise.id, lessonSlug, {\r\n        skippedQueueIds: updatedQueue,\r\n        skipCounts: { ...skipCounts, [qid]: currentSkipCount },\r\n        progress: newProgress,\r\n        phase,\r\n      } as any)\r\n\r\n      // Navigate forward\r\n      if (phase === \"main\") {\r\n        const nextIndex = progress.currentQuestionIndex + 1\r\n        if (nextIndex < exercise.questions.length) {\r\n          setTimeout(() => onQuestionChange(nextIndex), 0)\r\n          return\r\n        }\r\n        // End of main → go to skipped if available, else complete\r\n        if (updatedQueue.length > 0) {\r\n          setPhase(\"skipped\")\r\n          const firstId = updatedQueue[0]\r\n          const targetIdx = exercise.questions.findIndex(q => q.id === firstId)\r\n          if (targetIdx >= 0) setTimeout(() => onQuestionChange(targetIdx), 0)\r\n          return\r\n        }\r\n        const endTime = Date.now()\r\n        setProgress({ ...newProgress, endTime, completed: true })\r\n        setPendingResultSave(true)\r\n        return\r\n      } else {\r\n        // In skipped phase: move to next item in queue (preserve order)\r\n        const prePos = skippedQueueIds.indexOf(qid)\r\n        const nextId = prePos >= 0 && prePos < updatedQueue.length ? updatedQueue[prePos] : updatedQueue[0]\r\n        if (nextId) {\r\n          const targetIdx = exercise.questions.findIndex(q => q.id === nextId)\r\n          if (targetIdx >= 0) setTimeout(() => onQuestionChange(targetIdx), 0)\r\n          return\r\n        }\r\n        // No more skipped items → complete\r\n        const endTime = Date.now()\r\n        setProgress({ ...newProgress, endTime, completed: true })\r\n        setPendingResultSave(true)\r\n        return\r\n      }\r\n    }\r\n\r\n    // First or second skip\r\n    if (phase === \"main\") {\r\n      // Add to skipped queue if not present\r\n      const queueAfterAdd = skippedQueueIds.includes(qid) ? skippedQueueIds : [...skippedQueueIds, qid]\r\n      if (queueAfterAdd !== skippedQueueIds) {\r\n        setSkippedQueueIds(queueAfterAdd)\r\n        saveExerciseSession(exercise.id, lessonSlug, {\r\n          skippedQueueIds: queueAfterAdd,\r\n          skipCounts: { ...skipCounts, [qid]: currentSkipCount },\r\n          phase,\r\n        } as any)\r\n      } else {\r\n        // still persist counts\r\n        saveExerciseSession(exercise.id, lessonSlug, {\r\n          skipCounts: { ...skipCounts, [qid]: currentSkipCount },\r\n          phase,\r\n        } as any)\r\n      }\r\n      // Go to next main question or transition to skipped phase if main finished\r\n      const nextIndex = progress.currentQuestionIndex + 1\r\n      if (nextIndex < exercise.questions.length) {\r\n        setTimeout(() => onQuestionChange(nextIndex), 0)\r\n        return\r\n      }\r\n      // End of main → go to first skipped\r\n      if (queueAfterAdd.length > 0) {\r\n        setPhase(\"skipped\")\r\n        saveExerciseSession(exercise.id, lessonSlug, { phase: \"skipped\" } as any)\r\n        const firstId = queueAfterAdd[0]\r\n        const targetIdx = exercise.questions.findIndex(q => q.id === firstId)\r\n        if (targetIdx >= 0) setTimeout(() => onQuestionChange(targetIdx), 0)\r\n        return\r\n      }\r\n      // No skipped items: complete\r\n      const endTime = Date.now()\r\n      setProgress({ ...progress, endTime, completed: true })\r\n      setPendingResultSave(true)\r\n      return\r\n    } else {\r\n      // In skipped phase: move current to end for retry\r\n      const pos = skippedQueueIds.indexOf(qid)\r\n      if (pos >= 0) {\r\n        const updatedQueue = [...skippedQueueIds.slice(0, pos), ...skippedQueueIds.slice(pos + 1), qid]\r\n        setSkippedQueueIds(updatedQueue)\r\n        saveExerciseSession(exercise.id, lessonSlug, {\r\n          skippedQueueIds: updatedQueue,\r\n          skipCounts: { ...skipCounts, [qid]: currentSkipCount },\r\n          phase,\r\n        } as any)\r\n        // Navigate to next in queue if exists\r\n        const nextId = updatedQueue[pos]\r\n        if (nextId && nextId !== qid) {\r\n          const targetIdx = exercise.questions.findIndex(q => q.id === nextId)\r\n          if (targetIdx >= 0) setTimeout(() => onQuestionChange(targetIdx), 0)\r\n        }\r\n        // If only one item remains, staying on same question is fine\r\n      }\r\n    }\r\n  }, [exercise, lessonSlug, onQuestionChange, phase, progress, questionStartTime, skipCounts, skippedQueueIds, playSound])\r\n\r\n  const previousQuestion = useCallback(() => {\r\n    if (progress.currentQuestionIndex <= 0) return\r\n\r\n    const prevIndex = progress.currentQuestionIndex - 1\r\n    // Use a timeout to avoid setState during render\r\n    setTimeout(() => onQuestionChange(prevIndex), 0)\r\n  }, [progress.currentQuestionIndex, onQuestionChange])\r\n\r\n  const jumpToQuestion = useCallback((index: number) => {\r\n    if (!exercise || index < 0 || index >= exercise.questions.length) return\r\n    // Use a timeout to avoid setState during render\r\n    setTimeout(() => onQuestionChange(index), 0)\r\n  }, [exercise, onQuestionChange])\r\n\r\n  const completeExercise = useCallback(() => {\r\n    if (!exercise) return\r\n\r\n    const endTime = Date.now()\r\n    const finalProgress = {\r\n      ...progress,\r\n      endTime,\r\n      completed: true,\r\n    }\r\n    \r\n    console.log('[ExerciseContext] completeExercise called', {\r\n      exerciseId: exercise.id,\r\n      progress: finalProgress,\r\n    })\r\n    \r\n    setProgress(finalProgress)\r\n    setPendingResultSave(true)\r\n    // Completion handling is now done in the useEffect above\r\n  }, [exercise, progress])\r\n\r\n  const resetExercise = useCallback(async () => {\r\n    if (!exercise) return\r\n\r\n    clearExerciseSession(exercise.id, lessonSlug)\r\n    initialized.current = false\r\n    practiceResultId.current = null\r\n\r\n    // Start a new session via API\r\n    const newSession = await startApiSession(exercise.id)\r\n    if (newSession) {\r\n      practiceResultId.current = newSession.practiceResultId\r\n      console.log('[ExerciseContext] New session created on reset:', practiceResultId.current)\r\n    }\r\n\r\n    setProgress({\r\n      currentQuestionIndex: 0,\r\n      correctAnswers: 0,\r\n      incorrectAnswers: 0,\r\n      startTime: Date.now(),\r\n      completed: false,\r\n    })\r\n    setUserAnswer(null)\r\n    setIsAnswered(false)\r\n    setGradeResult(null)\r\n    setQuestionStartTime(Date.now())\r\n    setReviewMode(false)\r\n    setPhase(\"main\")\r\n    setSkippedQueueIds([])\r\n    setSkipCounts({})\r\n    setPendingResultSave(false)\r\n\r\n    // Schedule URL update after render\r\n    setTimeout(() => onQuestionChange(0), 0)\r\n  }, [exercise, lessonSlug, onQuestionChange, startApiSession])\r\n\r\n  const toggleReviewMode = useCallback(() => {\r\n    setReviewMode(prev => !prev)\r\n  }, [])\r\n\r\n  const currentQuestion = exercise ? exercise.questions[progress.currentQuestionIndex] : null\r\n  const currentQuestionIndex = progress.currentQuestionIndex\r\n  const isLastQuestion = exercise ? currentQuestionIndex === exercise.questions.length - 1 : false\r\n  const isFirstQuestion = currentQuestionIndex === 0\r\n\r\n  const getQuestionAttemptById = useCallback((questionId: string) => {\r\n    if (!exercise) return null\r\n    return getQuestionAttempt(exercise.id, lessonSlug, questionId)\r\n  }, [exercise, lessonSlug])\r\n\r\n  return (\r\n    <ExerciseContext.Provider\r\n      value={{\r\n        exercise,\r\n        progress,\r\n        currentQuestion,\r\n        currentQuestionIndex,\r\n        isLastQuestion,\r\n        isFirstQuestion,\r\n        questionStartTime,\r\n        userAnswer,\r\n        isAnswered,\r\n        gradeResult,\r\n        setUserAnswer,\r\n        submitAnswer,\r\n        skipQuestion,\r\n        nextQuestion,\r\n        previousQuestion,\r\n        jumpToQuestion,\r\n        completeExercise,\r\n        resetExercise,\r\n        startExercise,\r\n        reviewMode,\r\n        toggleReviewMode,\r\n        getQuestionAttempt: getQuestionAttemptById,\r\n      }}\r\n    >\r\n      {children}\r\n    </ExerciseContext.Provider>\r\n  )\r\n}\r\n\r\nexport const useExercise = () => {\r\n  const context = useContext(ExerciseContext)\r\n  if (context === undefined) {\r\n    throw new Error(\"useExercise must be used within an ExerciseProvider\")\r\n  }\r\n  return context\r\n}\r\n","\"use client\"\r\n\r\nimport { useCallback } from \"react\"\r\n\r\n// Simple sound utility hook for playing audio files\r\nexport function useSound() {\r\n  const playSound = useCallback((soundName: string) => {\r\n    try {\r\n      // Create audio instance\r\n      const audio = new Audio(`/sounds/${soundName}`)\r\n\r\n      // Set volume to reasonable level\r\n      audio.volume = 0.6\r\n\r\n      // Play the sound\r\n      audio.play().catch((error) => {\r\n        // Silently handle errors (e.g., user hasn't interacted with page yet)\r\n        console.debug('Sound play failed:', error)\r\n      })\r\n    } catch (error) {\r\n      console.debug('Sound utility error:', error)\r\n    }\r\n  }, [])\r\n\r\n  return { playSound }\r\n}","\"use client\"\r\n\r\nimport type { Exercise, Question, ExerciseProgress, MultipleChoiceQuestion, ChooseWordsQuestion, GrammarStructureQuestion } from \"@/features/learn/types\"\r\nimport { normalizeForComparison } from \"@/shared/utils/vi-normalize\"\r\n\r\n// Grading result interface\r\nexport interface GradeResult {\r\n  isCorrect: boolean\r\n  score: number\r\n  feedback?: string\r\n}\r\n\r\n// Question attempt interface for localStorage\r\nexport interface QuestionAttempt {\r\n  questionId: string\r\n  userAnswer: any\r\n  grade: GradeResult\r\n  timeSpentMs: number\r\n  timestamp: number\r\n  // Optional status to log non-answer events like skips\r\n  status?: \"answered\" | \"skipped\"\r\n  // Question type for analytics\r\n  questionType?: string\r\n}\r\n\r\n// Exercise session interface for localStorage\r\nexport interface ExerciseSession {\r\n  exerciseId: string\r\n  version: string\r\n  status: \"in_progress\" | \"completed\"\r\n  startedAt: number\r\n  lastUpdatedAt: number\r\n  currentQuestionIndex: number\r\n  attempts: QuestionAttempt[]\r\n  progress: ExerciseProgress\r\n  // Optional skip management state\r\n  skipCounts?: Record<string, number>\r\n  skippedQueueIds?: string[]\r\n  phase?: \"main\" | \"skipped\"\r\n}\r\n\r\n// Storage keys\r\nconst STORAGE_KEY_PREFIX = \"exercise\"\r\nconst VERSION = \"1.0.0\"\r\n\r\n// Client-side grading functions\r\nexport function gradeQuestion(question: Question, userAnswer: any): GradeResult {\r\n  switch (question.type) {\r\n    case \"multiple-choice\": {\r\n      const isCorrectMC = userAnswer === question.correctChoiceId\r\n      return {\r\n        isCorrect: isCorrectMC,\r\n        score: isCorrectMC ? 1 : 0,\r\n        feedback: isCorrectMC ? \"Correct!\" : `Incorrect. The correct answer is: ${question.choices.find(c => c.id === question.correctChoiceId)?.text}`\r\n      }\r\n    }\r\n\r\n    case \"word-matching\": {\r\n      // For word matching, check if all pairs are correctly matched\r\n      const correctPairs = question.pairs.length\r\n      let correctMatchesWM = 0\r\n      if (Array.isArray(userAnswer)) {\r\n        // New controlled mode: array of matched pair ids\r\n        correctMatchesWM = userAnswer.filter((id: any) =>\r\n          question.pairs.some(pair => pair.id === id)\r\n        ).length\r\n      } else {\r\n        // Legacy object mapping\r\n        correctMatchesWM = Object.values(userAnswer || {}).filter((match: any) =>\r\n          question.pairs.some(pair => pair.id === match.pairId && pair.vietnamese === match.vietnamese)\r\n        ).length\r\n      }\r\n      const isCorrectWM = correctMatchesWM === correctPairs\r\n      return {\r\n        isCorrect: isCorrectWM,\r\n        score: correctMatchesWM / correctPairs,\r\n        feedback: isCorrectWM ? \"Perfect matching!\" : `${correctMatchesWM}/${correctPairs} pairs correct`\r\n      }\r\n    }\r\n\r\n    case \"synonyms-matching\": {\r\n      const totalPairs = question.pairs.length\r\n      let correctMatchesSM = 0\r\n      if (Array.isArray(userAnswer)) {\r\n        // New controlled mode: array of matched pair ids\r\n        correctMatchesSM = userAnswer.filter((id: any) =>\r\n          question.pairs.some(pair => pair.id === id)\r\n        ).length\r\n      } else {\r\n        correctMatchesSM = Object.values(userAnswer || {}).filter((match: any) =>\r\n          question.pairs.some(pair => pair.id === match.pairId && pair.word2 === match.word2)\r\n        ).length\r\n      }\r\n      const isCorrectSM = correctMatchesSM === totalPairs\r\n      return {\r\n        isCorrect: isCorrectSM,\r\n        score: correctMatchesSM / totalPairs,\r\n        feedback: isCorrectSM ? \"All synonyms matched correctly!\" : `${correctMatchesSM}/${totalPairs} pairs correct`\r\n      }\r\n    }\r\n\r\n    case \"choose-words\": {\r\n      const q = question as ChooseWordsQuestion as any\r\n      const qd = q.question_data as any\r\n      const userWords: string[] = Array.isArray(userAnswer) ? userAnswer : []\r\n\r\n      if (qd && qd.subtype && qd.data) {\r\n        const subtype = qd.subtype as string\r\n        if (subtype === \"fill_in_blanks\") {\r\n          const correct: string[] = qd.data?.blanks?.correct || []\r\n          let correctCount = 0\r\n          for (let i = 0; i < correct.length; i++) {\r\n            // Use Vietnamese normalization for each word comparison\r\n            const normalizedUser = normalizeForComparison(userWords[i] || '')\r\n            const normalizedCorrect = normalizeForComparison(correct[i] || '')\r\n            if (normalizedUser === normalizedCorrect) correctCount++\r\n          }\r\n          const isCorrectCW = correct.length > 0 && correctCount === correct.length && userWords.length === correct.length\r\n          return {\r\n            isCorrect: isCorrectCW,\r\n            score: correct.length ? correctCount / correct.length : 0,\r\n            feedback: isCorrectCW ? \"All blanks correct!\" : `${correctCount}/${correct.length} blanks correct`\r\n          }\r\n        } else {\r\n          if (subtype === \"translation\") {\r\n            // For translation, evaluate equality against canonical sentence\r\n            // but compute partial progress using provided token chunks.\r\n            const correctTokens: string[] = qd.data?.tokens || []\r\n            const userSentence = userWords.join(\" \").trim()\r\n            const canonicalSentence = (qd.data?.canonical_sentence || correctTokens.join(\" \")).trim()\r\n\r\n            // Use Vietnamese normalization that handles diacritics and punctuation\r\n            const normalizedUser = normalizeForComparison(userSentence)\r\n            const normalizedCanonical = normalizeForComparison(canonicalSentence)\r\n\r\n            let correctCount = 0\r\n            const len = Math.min(userWords.length, correctTokens.length)\r\n            for (let i = 0; i < len; i++) {\r\n              const normalizedUserWord = normalizeForComparison(userWords[i] || '')\r\n              const normalizedCorrectWord = normalizeForComparison(correctTokens[i] || '')\r\n              if (normalizedUserWord === normalizedCorrectWord) correctCount++\r\n            }\r\n\r\n            const isCorrectCW = (\r\n              correctTokens.length > 0 &&\r\n              userWords.length === correctTokens.length &&\r\n              normalizedUser === normalizedCanonical\r\n            )\r\n            return {\r\n              isCorrect: isCorrectCW,\r\n              score: correctTokens.length ? correctCount / correctTokens.length : 0,\r\n              feedback: isCorrectCW ? \"Perfect translation!\" : `${correctCount}/${correctTokens.length} tokens in correct order`\r\n            }\r\n          } else {\r\n            // sentence-scramble or other token-ordered variants\r\n            const correctTokens: string[] = qd.data?.tokens || []\r\n            let correctCount = 0\r\n            const len = Math.min(userWords.length, correctTokens.length)\r\n            for (let i = 0; i < len; i++) {\r\n              // Use Vietnamese normalization for each word comparison\r\n              const normalizedUser = normalizeForComparison(userWords[i] || '')\r\n              const normalizedCorrect = normalizeForComparison(correctTokens[i] || '')\r\n              if (normalizedUser === normalizedCorrect) correctCount++\r\n            }\r\n            const isCorrectCW = (\r\n              correctTokens.length > 0 &&\r\n              userWords.length === correctTokens.length &&\r\n              correctCount === correctTokens.length\r\n            )\r\n            return {\r\n              isCorrect: isCorrectCW,\r\n              score: correctTokens.length ? correctCount / correctTokens.length : 0,\r\n              feedback: isCorrectCW ? \"Perfect sentence!\" : `${correctCount}/${correctTokens.length} tokens in correct order`\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // Legacy fallback\r\n      const correctWords: string[] = (question as any).correctAnswer || []\r\n      let correctCount = 0\r\n      for (const userWord of userWords) {\r\n        // Check if this word matches any correct word using normalization\r\n        const normalizedUser = normalizeForComparison(userWord)\r\n        if (correctWords.some(cw => normalizeForComparison(cw) === normalizedUser)) {\r\n          correctCount++\r\n        }\r\n      }\r\n      const isCorrectCW = correctWords.length > 0 && correctCount === correctWords.length && userWords.length === correctWords.length\r\n      return {\r\n        isCorrect: isCorrectCW,\r\n        score: correctWords.length ? correctCount / correctWords.length : 0,\r\n        feedback: isCorrectCW ? \"Perfect translation!\" : `${correctCount}/${correctWords.length || 0} words correct`\r\n      }\r\n    }\r\n\r\n    case \"error-correction\": {\r\n      // Use Vietnamese normalization that ignores diacritics and punctuation\r\n      const normalizedUserAnswer = normalizeForComparison(userAnswer || '')\r\n      const normalizedTarget = normalizeForComparison(question.target)\r\n      const isCorrectCorrection = normalizedUserAnswer === normalizedTarget\r\n      return {\r\n        isCorrect: isCorrectCorrection,\r\n        score: isCorrectCorrection ? 1 : 0,\r\n        feedback: isCorrectCorrection ? \"Correct correction!\" : `The correct sentence is: \"${question.target}\"`\r\n      }\r\n    }\r\n\r\n    case \"grammar-structure\": {\r\n      const q = question as GrammarStructureQuestion\r\n      const isCorrectGrammar = userAnswer === q.correctChoiceId\r\n      return {\r\n        isCorrect: isCorrectGrammar,\r\n        score: isCorrectGrammar ? 1 : 0,\r\n        feedback: isCorrectGrammar ? \"Correct grammar!\" : `Incorrect. ${q.hint || \"Please review the grammar rule.\"}`\r\n      }\r\n    }\r\n\r\n    case \"dialogue-completion\": {\r\n      const isCorrectDialogue = userAnswer === question.correctChoiceId\r\n      return {\r\n        isCorrect: isCorrectDialogue,\r\n        score: isCorrectDialogue ? 1 : 0,\r\n        feedback: isCorrectDialogue ? \"Good dialogue completion!\" : \"Try a more appropriate response\"\r\n      }\r\n    }\r\n\r\n    case \"role-play\": {\r\n      // For role-play, check if user selected the expected choice for each step\r\n      const userChoices = userAnswer || []\r\n      const totalSteps = question.steps.length\r\n      const correctSteps = question.steps.filter((step, index) =>\r\n        userChoices[index] === step.expected\r\n      ).length\r\n      const accuracy = correctSteps / totalSteps\r\n      const isCorrectRP = accuracy > 0.5 // More than 50% correct steps\r\n      return {\r\n        isCorrect: isCorrectRP,\r\n        score: accuracy,\r\n        feedback: isCorrectRP\r\n          ? `Great role-play! ${correctSteps}/${totalSteps} steps correct (${Math.round(accuracy * 100)}% accuracy)`\r\n          : `${correctSteps}/${totalSteps} steps correct (${Math.round(accuracy * 100)}% accuracy). Try to get more than 50% correct next time!`\r\n      }\r\n    }\r\n\r\n    default:\r\n      return {\r\n        isCorrect: false,\r\n        score: 0,\r\n        feedback: \"Unknown question type\"\r\n      }\r\n  }\r\n}\r\n\r\n// LocalStorage management\r\nexport function getStorageKey(exerciseId: string, lessonSlug?: string): string {\r\n  return `${STORAGE_KEY_PREFIX}:${exerciseId}:${lessonSlug || 'default'}:${VERSION}`\r\n}\r\n\r\nexport function saveExerciseSession(\r\n  exerciseId: string,\r\n  lessonSlug: string,\r\n  session: Partial<ExerciseSession>\r\n): void {\r\n  try {\r\n    const key = getStorageKey(exerciseId, lessonSlug)\r\n    const existingSession = loadExerciseSession(exerciseId, lessonSlug)\r\n\r\n    const updatedSession: ExerciseSession = {\r\n      exerciseId,\r\n      version: VERSION,\r\n      status: \"in_progress\",\r\n      startedAt: Date.now(),\r\n      currentQuestionIndex: 0,\r\n      attempts: [],\r\n      progress: {\r\n        currentQuestionIndex: 0,\r\n        correctAnswers: 0,\r\n        incorrectAnswers: 0,\r\n        startTime: Date.now(),\r\n        completed: false,\r\n      },\r\n      ...existingSession,\r\n      ...session,\r\n      lastUpdatedAt: Date.now(),\r\n    }\r\n\r\n    localStorage.setItem(key, JSON.stringify(updatedSession))\r\n  } catch (error) {\r\n    console.warn(\"Failed to save exercise session:\", error)\r\n  }\r\n}\r\n\r\nexport function loadExerciseSession(exerciseId: string, lessonSlug: string): ExerciseSession | null {\r\n  try {\r\n    const key = getStorageKey(exerciseId, lessonSlug)\r\n    const stored = localStorage.getItem(key)\r\n    if (!stored) return null\r\n\r\n    const session: ExerciseSession = JSON.parse(stored)\r\n\r\n    // Check version compatibility\r\n    if (session.version !== VERSION) {\r\n      console.warn(\"Exercise session version mismatch, starting fresh\")\r\n      return null\r\n    }\r\n\r\n    return session\r\n  } catch (error) {\r\n    console.warn(\"Failed to load exercise session:\", error)\r\n    return null\r\n  }\r\n}\r\n\r\nexport function clearExerciseSession(exerciseId: string, lessonSlug: string): void {\r\n  try {\r\n    const key = getStorageKey(exerciseId, lessonSlug)\r\n    localStorage.removeItem(key)\r\n  } catch (error) {\r\n    console.warn(\"Failed to clear exercise session:\", error)\r\n  }\r\n}\r\n\r\nexport function saveQuestionAttempt(\r\n  exerciseId: string,\r\n  lessonSlug: string,\r\n  attempt: QuestionAttempt\r\n): void {\r\n  const session = loadExerciseSession(exerciseId, lessonSlug)\r\n  if (!session) return\r\n\r\n  // Remove any existing attempt for this question\r\n  session.attempts = session.attempts.filter(a => a.questionId !== attempt.questionId)\r\n  session.attempts.push(attempt)\r\n\r\n  saveExerciseSession(exerciseId, lessonSlug, session)\r\n}\r\n\r\nexport function getQuestionAttempt(\r\n  exerciseId: string,\r\n  lessonSlug: string,\r\n  questionId: string\r\n): QuestionAttempt | null {\r\n  const session = loadExerciseSession(exerciseId, lessonSlug)\r\n  if (!session) return null\r\n\r\n  return session.attempts.find(a => a.questionId === questionId) || null\r\n}\r\n\r\n// Utility functions\r\nexport function calculateAccuracy(progress: ExerciseProgress): number {\r\n  const total = progress.correctAnswers + progress.incorrectAnswers\r\n  return total > 0 ? Math.round((progress.correctAnswers / total) * 100) : 0\r\n}\r\n\r\nexport function isExercisePassed(accuracy: number, threshold?: number, zoneLevel?: number): boolean {\r\n  // If threshold is provided, use it\r\n  if (threshold !== undefined) {\r\n    return accuracy >= threshold\r\n  }\r\n  \r\n  // If zoneLevel is provided, use zone-based thresholds\r\n  if (zoneLevel !== undefined) {\r\n    const zoneThresholds: Record<number, number> = {\r\n      1: 65, // Beginner\r\n      2: 70, // Elementary\r\n      3: 75, // Intermediate\r\n      4: 80, // Upper-Intermediate\r\n      5: 85, // Advanced\r\n    }\r\n    const zoneThreshold = zoneThresholds[zoneLevel] || 80\r\n    return accuracy >= zoneThreshold\r\n  }\r\n  \r\n  // Default fallback to 80%\r\n  return accuracy >= 80\r\n}\r\n\r\nexport function getResumeQuestionIndex(session: ExerciseSession | null, totalQuestions: number): number {\r\n  if (!session) return 0\r\n\r\n  // If completed, start from beginning\r\n  if (session.status === \"completed\") return 0\r\n\r\n  // Resume from last attempted question, but don't go beyond available questions\r\n  return Math.min(session.currentQuestionIndex, totalQuestions - 1)\r\n}\r\n"],"names":[],"mappings":"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"}