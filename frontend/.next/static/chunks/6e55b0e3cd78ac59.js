(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,978618,e=>{"use strict";e.s(["normalizeForComparison",()=>s,"searchVietnamese",()=>n]);let t={à:"a",á:"a",ả:"a",ã:"a",ạ:"a",ă:"a",ằ:"a",ắ:"a",ẳ:"a",ẵ:"a",ặ:"a",â:"a",ầ:"a",ấ:"a",ẩ:"a",ẫ:"a",ậ:"a",è:"e",é:"e",ẻ:"e",ẽ:"e",ẹ:"e",ê:"e",ề:"e",ế:"e",ể:"e",ễ:"e",ệ:"e",ì:"i",í:"i",ỉ:"i",ĩ:"i",ị:"i",ò:"o",ó:"o",ỏ:"o",õ:"o",ọ:"o",ô:"o",ồ:"o",ố:"o",ổ:"o",ỗ:"o",ộ:"o",ơ:"o",ờ:"o",ớ:"o",ở:"o",ỡ:"o",ợ:"o",ù:"u",ú:"u",ủ:"u",ũ:"u",ụ:"u",ư:"u",ừ:"u",ứ:"u",ử:"u",ữ:"u",ự:"u",ỳ:"y",ý:"y",ỷ:"y",ỹ:"y",ỵ:"y",đ:"d",À:"A",Á:"A",Ả:"A",Ã:"A",Ạ:"A",Ă:"A",Ằ:"A",Ắ:"A",Ẳ:"A",Ẵ:"A",Ặ:"A",Â:"A",Ầ:"A",Ấ:"A",Ẩ:"A",Ẫ:"A",Ậ:"A",È:"E",É:"E",Ẻ:"E",Ẽ:"E",Ẹ:"E",Ê:"E",Ề:"E",Ế:"E",Ể:"E",Ễ:"E",Ệ:"E",Ì:"I",Í:"I",Ỉ:"I",Ĩ:"I",Ị:"I",Ò:"O",Ó:"O",Ỏ:"O",Õ:"O",Ọ:"O",Ô:"O",Ồ:"O",Ố:"O",Ổ:"O",Ỗ:"O",Ộ:"O",Ơ:"O",Ờ:"O",Ớ:"O",Ở:"O",Ỡ:"O",Ợ:"O",Ù:"U",Ú:"U",Ủ:"U",Ũ:"U",Ụ:"U",Ư:"U",Ừ:"U",Ứ:"U",Ử:"U",Ữ:"U",Ự:"U",Ỳ:"Y",Ý:"Y",Ỷ:"Y",Ỹ:"Y",Ỵ:"Y",Đ:"D"};function r(e){if(!e)return"";let r=e;for(let[e,s]of Object.entries(t))r=r.replace(RegExp(e,"g"),s);return r}function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return"";let{preserveCase:s=!1,preserveWhitespace:n=!1}=t,o=r(e);return o=o.replace(RegExp("[\\p{P}\\p{S}]+","gu"),""),n||(o=o.replace(/\s+/g," ").trim()),s||(o=o.toLowerCase()),o}function n(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e||!t)return!1;let n=r(e),o=r(t);return s?n.includes(o):n.toLowerCase().includes(o.toLowerCase())}},584647,e=>{"use strict";e.s(["useExerciseSession",()=>r]);var t=e.i(271645);function r(){let e=(0,t.useRef)(!1),r=(0,t.useRef)(!1),s=(0,t.useCallback)(async t=>{if(e.current)return console.warn("[useExerciseSession] Start already in progress"),null;e.current=!0;try{console.log("[useExerciseSession] Starting exercise:",t);let e=await fetch("/api/exercise/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({practiceSetId:t})}),r=await e.json();if(!e.ok||!r.success)return console.error("[useExerciseSession] Failed to start exercise:",{status:e.status,statusText:e.statusText,error:r.error,data:r}),null;return console.log("[useExerciseSession] Exercise started:",{practiceResultId:r.practiceResultId,attemptNo:r.attemptNo,resumed:r.resumed}),{practiceResultId:r.practiceResultId,attemptNo:r.attemptNo}}catch(e){return console.error("[useExerciseSession] Error starting exercise:",e),null}finally{e.current=!1}},[]);return{startExercise:s,submitExercise:(0,t.useCallback)(async e=>{if(r.current)return console.warn("[useExerciseSession] Submit already in progress"),{success:!1,error:"Submit already in progress"};r.current=!0;try{console.log("[useExerciseSession] Submitting exercise:",{practiceResultId:e.practiceResultId,scorePercent:e.scorePercent,passed:e.passed});let t=await fetch("/api/exercise/submit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(!t.ok||!r.success)return console.error("[useExerciseSession] Failed to submit exercise:",r.error),{success:!1,error:r.error};return console.log("[useExerciseSession] Exercise submitted successfully:",{isFirstPass:r.isFirstPass,coinsEarned:r.coinsEarned,xpEarned:r.xpEarned}),r}catch(e){return console.error("[useExerciseSession] Error submitting exercise:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}finally{r.current=!1}},[]),checkForResume:(0,t.useCallback)(async e=>{try{console.log("[useExerciseSession] Checking for in_progress session:",e);let t=await fetch("/api/exercise/resume?practiceSetId=".concat(e)),r=await t.json();if(!t.ok||!r.success)return console.error("[useExerciseSession] Failed to check resume:",r.error),null;if(r.practiceResult)return console.log("[useExerciseSession] Found in_progress session:",r.practiceResult.id),{practiceResultId:r.practiceResult.id,attemptNo:r.practiceResult.attemptNo};return console.log("[useExerciseSession] No in_progress session found"),null}catch(e){return console.error("[useExerciseSession] Error checking resume:",e),null}},[])}}},543687,971094,e=>{"use strict";e.s(["ExerciseProvider",()=>I,"useExercise",()=>C],543687);var t=e.i(843476),r=e.i(271645),s=e.i(794846),n=e.i(584647),o=e.i(912598),i=e.i(761163),c=e.i(545208);e.s(["calculateAccuracy",()=>h,"clearExerciseSession",()=>g,"getQuestionAttempt",()=>x,"gradeQuestion",()=>u,"isExercisePassed",()=>y,"loadExerciseSession",()=>m,"saveExerciseSession",()=>p,"saveQuestionAttempt",()=>f],971094);var a=e.i(978618);let l="1.0.0";function u(e,t){var r,s,n,o,i,c;switch(e.type){case"multiple-choice":{let s=t===e.correctChoiceId;return{isCorrect:s,score:+!!s,feedback:s?"Correct!":"Incorrect. The correct answer is: ".concat(null==(r=e.choices.find(t=>t.id===e.correctChoiceId))?void 0:r.text)}}case"word-matching":{let r=e.pairs.length,s=0,n=(s=Array.isArray(t)?t.filter(t=>e.pairs.some(e=>e.id===t)).length:Object.values(t||{}).filter(t=>e.pairs.some(e=>e.id===t.pairId&&e.vietnamese===t.vietnamese)).length)===r;return{isCorrect:n,score:s/r,feedback:n?"Perfect matching!":"".concat(s,"/").concat(r," pairs correct")}}case"synonyms-matching":{let r=e.pairs.length,s=0,n=(s=Array.isArray(t)?t.filter(t=>e.pairs.some(e=>e.id===t)).length:Object.values(t||{}).filter(t=>e.pairs.some(e=>e.id===t.pairId&&e.word2===t.word2)).length)===r;return{isCorrect:n,score:s/r,feedback:n?"All synonyms matched correctly!":"".concat(s,"/").concat(r," pairs correct")}}case"choose-words":{let r=e.question_data,l=Array.isArray(t)?t:[];if(r&&r.subtype&&r.data){let e=r.subtype;if("fill_in_blanks"===e){let e=(null==(n=r.data)||null==(s=n.blanks)?void 0:s.correct)||[],t=0;for(let r=0;r<e.length;r++)(0,a.normalizeForComparison)(l[r]||"")===(0,a.normalizeForComparison)(e[r]||"")&&t++;let o=e.length>0&&t===e.length&&l.length===e.length;return{isCorrect:o,score:e.length?t/e.length:0,feedback:o?"All blanks correct!":"".concat(t,"/").concat(e.length," blanks correct")}}if("translation"===e){let e=(null==(o=r.data)?void 0:o.tokens)||[],t=l.join(" ").trim(),s=((null==(i=r.data)?void 0:i.canonical_sentence)||e.join(" ")).trim(),n=(0,a.normalizeForComparison)(t),c=(0,a.normalizeForComparison)(s),u=0,d=Math.min(l.length,e.length);for(let t=0;t<d;t++)(0,a.normalizeForComparison)(l[t]||"")===(0,a.normalizeForComparison)(e[t]||"")&&u++;let p=e.length>0&&l.length===e.length&&n===c;return{isCorrect:p,score:e.length?u/e.length:0,feedback:p?"Perfect translation!":"".concat(u,"/").concat(e.length," tokens in correct order")}}{let e=(null==(c=r.data)?void 0:c.tokens)||[],t=0,s=Math.min(l.length,e.length);for(let r=0;r<s;r++)(0,a.normalizeForComparison)(l[r]||"")===(0,a.normalizeForComparison)(e[r]||"")&&t++;let n=e.length>0&&l.length===e.length&&t===e.length;return{isCorrect:n,score:e.length?t/e.length:0,feedback:n?"Perfect sentence!":"".concat(t,"/").concat(e.length," tokens in correct order")}}}let u=e.correctAnswer||[],d=0;for(let e of l){let t=(0,a.normalizeForComparison)(e);u.some(e=>(0,a.normalizeForComparison)(e)===t)&&d++}let p=u.length>0&&d===u.length&&l.length===u.length;return{isCorrect:p,score:u.length?d/u.length:0,feedback:p?"Perfect translation!":"".concat(d,"/").concat(u.length||0," words correct")}}case"error-correction":{let r=(0,a.normalizeForComparison)(t||"")===(0,a.normalizeForComparison)(e.target);return{isCorrect:r,score:+!!r,feedback:r?"Correct correction!":'The correct sentence is: "'.concat(e.target,'"')}}case"grammar-structure":{let r=t===e.correctChoiceId;return{isCorrect:r,score:+!!r,feedback:r?"Correct grammar!":"Incorrect. ".concat(e.hint||"Please review the grammar rule.")}}case"dialogue-completion":{let r=t===e.correctChoiceId;return{isCorrect:r,score:+!!r,feedback:r?"Good dialogue completion!":"Try a more appropriate response"}}case"role-play":{let r=t||[],s=e.steps.length,n=e.steps.filter((e,t)=>r[t]===e.expected).length,o=n/s,i=o>.5;return{isCorrect:i,score:o,feedback:i?"Great role-play! ".concat(n,"/").concat(s," steps correct (").concat(Math.round(100*o),"% accuracy)"):"".concat(n,"/").concat(s," steps correct (").concat(Math.round(100*o),"% accuracy). Try to get more than 50% correct next time!")}}default:return{isCorrect:!1,score:0,feedback:"Unknown question type"}}}function d(e,t){return"".concat("exercise",":").concat(e,":").concat(t||"default",":").concat(l)}function p(e,t,r){try{let s=d(e,t),n=m(e,t),o={exerciseId:e,version:l,status:"in_progress",startedAt:Date.now(),currentQuestionIndex:0,attempts:[],progress:{currentQuestionIndex:0,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1},...n,...r,lastUpdatedAt:Date.now()};localStorage.setItem(s,JSON.stringify(o))}catch(e){console.warn("Failed to save exercise session:",e)}}function m(e,t){try{let r=d(e,t),s=localStorage.getItem(r);if(!s)return null;let n=JSON.parse(s);if(n.version!==l)return console.warn("Exercise session version mismatch, starting fresh"),null;return n}catch(e){return console.warn("Failed to load exercise session:",e),null}}function g(e,t){try{let r=d(e,t);localStorage.removeItem(r)}catch(e){console.warn("Failed to clear exercise session:",e)}}function f(e,t,r){let s=m(e,t);s&&(s.attempts=s.attempts.filter(e=>e.questionId!==r.questionId),s.attempts.push(r),p(e,t,s))}function x(e,t,r){let s=m(e,t);return s&&s.attempts.find(e=>e.questionId===r)||null}function h(e){let t=e.correctAnswers+e.incorrectAnswers;return t>0?Math.round(e.correctAnswers/t*100):0}function y(e,t,r){return void 0!==t?e>=t:void 0!==r?e>=(({1:65,2:70,3:75,4:80,5:85})[r]||80):e>=80}let w=(0,r.createContext)(void 0),I=e=>{let{children:a,exerciseData:l,topicSlug:d,lessonSlug:I,urlQuestionIndex:C,onQuestionChange:E}=e,[v,A]=(0,r.useState)(null),[S,k]=(0,r.useState)({currentQuestionIndex:0,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1}),[b,T]=(0,r.useState)(null),[Q,q]=(0,r.useState)(!1),[O,P]=(0,r.useState)(null),[_,D]=(0,r.useState)(Date.now()),[F,R]=(0,r.useState)(!1),[z,U]=(0,r.useState)("main"),[N,j]=(0,r.useState)([]),[M,K]=(0,r.useState)({}),[Y,J]=(0,r.useState)(!1),{toast:L}=(0,s.useToast)(),{playSound:B}={playSound:(0,r.useCallback)(e=>{try{let t=new Audio("/sounds/".concat(e));t.volume=.6,t.play().catch(e=>{console.debug("Sound play failed:",e)})}catch(e){console.debug("Sound utility error:",e)}},[])},{startExercise:G,submitExercise:V,checkForResume:X}=(0,n.useExerciseSession)(),H=(0,o.useQueryClient)(),{user:W}=(0,c.useUserProfile)(),Z=(0,r.useRef)(!1),$=(0,r.useRef)(!1),ee=(0,r.useRef)(null);(0,r.useEffect)(()=>{l&&!Z.current&&(async()=>{try{if(!l.id){console.error("[ExerciseContext] Invalid exercise data - missing id:",l),L({title:"Error",description:"Invalid exercise data. Please refresh the page.",variant:"destructive"});return}let e=m(l.id,I),t=await X(l.id);if(t){console.log("[ExerciseContext] Resuming from API session:",t.practiceResultId),ee.current=t.practiceResultId;let r=e?Math.min(e.currentQuestionIndex,l.questions.length-1):0;A(l),k((null==e?void 0:e.progress)||{currentQuestionIndex:r,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1}),U((null==e?void 0:e.phase)||"main"),j((null==e?void 0:e.skippedQueueIds)||[]),K((null==e?void 0:e.skipCounts)||{})}else{console.error("[ExerciseContext] No active session found - redirecting to lesson page"),L({title:"No Active Session",description:"Please start the exercise from the lesson page.",variant:"destructive"}),window.location.href="/learn/".concat(d,"/").concat(I);return}Z.current=!0}catch(e){console.error("[ExerciseContext] Error initializing session:",e),L({title:"Initialization Error",description:"Could not initialize exercise. Please try again.",variant:"destructive"})}})()},[l,I,X,G,L]),(0,r.useEffect)(()=>{if(!v||C<0||C>=v.questions.length)return;let e=v.questions[C];if(!e)return;let t=x(v.id,I,e.id);k(e=>({...e,currentQuestionIndex:C})),T((null==t?void 0:t.userAnswer)||null),q(!!t),P((null==t?void 0:t.grade)||null),D(Date.now())},[C,v,I]),(0,r.useEffect)(()=>{if(console.log("[ExerciseContext] Completion check:",{pendingResultSave:Y,isSaving:$.current,hasExercise:!!v,completed:S.completed,hasEndTime:!!S.endTime}),!Y||$.current||!v||!S.completed||!S.endTime)return;let e=!1;return $.current=!0,(async()=>{if(console.log("[ExerciseContext] Starting handleCompletion"),!ee.current){console.error("[ExerciseContext] No practice result ID found, cannot save results"),L({title:"Session Error",description:"Exercise session not found. Your progress may not be saved.",variant:"destructive"});return}let e=m(v.id,I),t=(null==e?void 0:e.attempts)||[],r=v.questions.length,s=S.correctAnswers/r*100,n=r-S.correctAnswers-S.incorrectAnswers,o=Math.floor((S.endTime-S.startTime)/1e3),c=Math.round((S.endTime-S.startTime)/6e4),a=h(S),l=y(a,void 0,v.zoneLevel);console.log("[ExerciseContext] Exercise metrics:",{practiceResultId:ee.current,totalQuestions:r,scorePercent:s,totalSkipped:n,timeSpentSeconds:o,studyTimeMinutes:c,accuracy:a,passed:l,attemptsCount:t.length});let u=await V({practiceResultId:ee.current,practiceSetId:v.id,scorePercent:s,totalCorrect:S.correctAnswers,totalIncorrect:S.incorrectAnswers,totalSkipped:n,timeSpentSeconds:o,passed:l,attempts:t});if(!u){console.error("[ExerciseContext] Failed to submit exercise results to API"),L({title:"Save Failed",description:"Your progress could not be saved. Please try again.",variant:"destructive"});return}if(console.log("[ExerciseContext] Exercise result submitted successfully:",u),(null==W?void 0:W.id)&&u.topicId&&u.lessonId){console.log("[ExerciseContext] Applying optimistic update and invalidating cache for topic:",u.topicId);let e=u.topicId,t=u.lessonId,r=i.queryKeys.lessonProgress.topic(W.id,e);H.getQueryData(r),H.setQueryData(r,r=>{if(!r||!Array.isArray(r))return r;let n=r.findIndex(e=>e.lesson_id===t);if(!(n>=0))return[...r,{lesson_id:t,topic_id:e,best_score_percent:s,total_attempts:1,status:l?"passed":"in_progress",last_attempted_at:new Date().toISOString(),passed_at:l?new Date().toISOString():null}];{let e=[...r];return e[n]={...e[n],best_score_percent:Math.max(s,e[n].best_score_percent||0),total_attempts:(e[n].total_attempts||0)+1,status:l?"passed":"in_progress",last_attempted_at:new Date().toISOString(),passed_at:l?new Date().toISOString():e[n].passed_at},e}}),H.invalidateQueries({queryKey:i.queryKeys.lessonProgress.topic(W.id,e)}),H.invalidateQueries({queryKey:i.queryKeys.user.progress()}),H.invalidateQueries({queryKey:i.queryKeys.quests.progress()})}g(v.id,I),ee.current=null;let d=u.isFirstPass?"Earned ".concat(u.coinsEarned," coins and ").concat(u.xpEarned," XP!"):"Keep practicing to improve!";L({title:"Exercise Completed!",description:"Accuracy: ".concat(a,"%. ").concat(l?"Passed!":"Try again to improve."," ").concat(d),variant:l?"default":"destructive"})})().finally(()=>{$.current=!1,e||J(!1)}),()=>{e=!0}},[Y,v,S.completed,S.endTime,S.correctAnswers,S.incorrectAnswers,S.startTime,I,L,V,H,null==W?void 0:W.id]);let et=(0,r.useCallback)((e,t,r)=>{A(e);let s=m(e.id,r);if(s)k(s.progress),setTimeout(()=>E(s.currentQuestionIndex),0);else{let t={currentQuestionIndex:0,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1};k(t),p(e.id,r,{status:"in_progress",currentQuestionIndex:0,progress:t}),setTimeout(()=>E(0),0)}T(null),q(!1),P(null),D(Date.now()),J(!1)},[E]),er=(0,r.useCallback)(()=>{if(!v||!v.questions[S.currentQuestionIndex]||Q)return;let e=v.questions[S.currentQuestionIndex],t=Date.now()-_,r=u(e,b);r.isCorrect?B("correct.mp3"):B("incorrect.wav");let s={questionId:e.id,userAnswer:b,grade:r,timeSpentMs:t,timestamp:Date.now(),questionType:e.type};f(v.id,I,s);let n={...S,correctAnswers:S.correctAnswers+ +!!r.isCorrect,incorrectAnswers:S.incorrectAnswers+ +!r.isCorrect};if(k(n),"skipped"===z){let t=e.id;if(N.includes(t)){let e=N.filter(e=>e!==t);j(e),p(v.id,I,{skippedQueueIds:e,skipCounts:M,phase:z})}}p(v.id,I,{currentQuestionIndex:S.currentQuestionIndex,progress:n}),q(!0),P(r)},[v,b,Q,_,S,I,z,N,M,B]),es=(0,r.useCallback)(()=>{var e;if(!v)return;let t=v.questions.length;if("main"===z){let e=S.currentQuestionIndex+1;if(e>=t){if(N.length>0){U("skipped"),p(v.id,I,{phase:"skipped"});let e=N[0],t=v.questions.findIndex(t=>t.id===e);t>=0&&setTimeout(()=>E(t),0);return}let e=Date.now();k({...S,endTime:e,completed:!0}),J(!0);return}setTimeout(()=>E(e),0);return}let r=null==(e=v.questions[S.currentQuestionIndex])?void 0:e.id,s=r?N.indexOf(r):-1,n=s>=0?s+1:0;if(n<N.length){let e=N[n],t=v.questions.findIndex(t=>t.id===e);t>=0&&setTimeout(()=>E(t),0);return}let o=Date.now();k({...S,endTime:o,completed:!0}),J(!0)},[v,E,z,S,N]),en=(0,r.useCallback)(()=>{if(!v)return;let e=v.questions[S.currentQuestionIndex];if(!e)return;B("flip.mp3");let t=e.id;K(e=>{let r=(e[t]||0)+1,s={...e,[t]:r};return p(v.id,I,{skipCounts:s,skippedQueueIds:N,phase:z}),s});let r=(M[t]||0)+1;if(r>=3){let s={questionId:t,userAnswer:null,grade:{isCorrect:!1,score:0,feedback:"Marked incorrect after 3 skips"},timeSpentMs:Date.now()-_,timestamp:Date.now(),status:"skipped",questionType:e.type};f(v.id,I,s);let n={...S,incorrectAnswers:S.incorrectAnswers+1};k(n);let o=N.indexOf(t),i=N;if(o>=0&&j(i=[...N.slice(0,o),...N.slice(o+1)]),p(v.id,I,{skippedQueueIds:i,skipCounts:{...M,[t]:r},progress:n,phase:z}),"main"===z){let e=S.currentQuestionIndex+1;if(e<v.questions.length)return void setTimeout(()=>E(e),0);if(i.length>0){U("skipped");let e=i[0],t=v.questions.findIndex(t=>t.id===e);t>=0&&setTimeout(()=>E(t),0);return}let t=Date.now();return k({...n,endTime:t,completed:!0}),void J(!0)}{let e=N.indexOf(t),r=e>=0&&e<i.length?i[e]:i[0];if(r){let e=v.questions.findIndex(e=>e.id===r);e>=0&&setTimeout(()=>E(e),0);return}let s=Date.now();k({...n,endTime:s,completed:!0}),J(!0);return}}if("main"===z){let e=N.includes(t)?N:[...N,t];e!==N?(j(e),p(v.id,I,{skippedQueueIds:e,skipCounts:{...M,[t]:r},phase:z})):p(v.id,I,{skipCounts:{...M,[t]:r},phase:z});let s=S.currentQuestionIndex+1;if(s<v.questions.length)return void setTimeout(()=>E(s),0);if(e.length>0){U("skipped"),p(v.id,I,{phase:"skipped"});let t=e[0],r=v.questions.findIndex(e=>e.id===t);r>=0&&setTimeout(()=>E(r),0);return}let n=Date.now();return k({...S,endTime:n,completed:!0}),void J(!0)}{let e=N.indexOf(t);if(e>=0){let s=[...N.slice(0,e),...N.slice(e+1),t];j(s),p(v.id,I,{skippedQueueIds:s,skipCounts:{...M,[t]:r},phase:z});let n=s[e];if(n&&n!==t){let e=v.questions.findIndex(e=>e.id===n);e>=0&&setTimeout(()=>E(e),0)}}}},[v,I,E,z,S,_,M,N,B]),eo=(0,r.useCallback)(()=>{if(S.currentQuestionIndex<=0)return;let e=S.currentQuestionIndex-1;setTimeout(()=>E(e),0)},[S.currentQuestionIndex,E]),ei=(0,r.useCallback)(e=>{!v||e<0||e>=v.questions.length||setTimeout(()=>E(e),0)},[v,E]),ec=(0,r.useCallback)(()=>{if(!v)return;let e=Date.now(),t={...S,endTime:e,completed:!0};console.log("[ExerciseContext] completeExercise called",{exerciseId:v.id,progress:t}),k(t),J(!0)},[v,S]),ea=(0,r.useCallback)(async()=>{if(!v)return;g(v.id,I),Z.current=!1,ee.current=null;let e=await G(v.id);e&&(ee.current=e.practiceResultId,console.log("[ExerciseContext] New session created on reset:",ee.current)),k({currentQuestionIndex:0,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1}),T(null),q(!1),P(null),D(Date.now()),R(!1),U("main"),j([]),K({}),J(!1),setTimeout(()=>E(0),0)},[v,I,E,G]),el=(0,r.useCallback)(()=>{R(e=>!e)},[]),eu=v?v.questions[S.currentQuestionIndex]:null,ed=S.currentQuestionIndex,ep=!!v&&ed===v.questions.length-1,em=(0,r.useCallback)(e=>v?x(v.id,I,e):null,[v,I]);return(0,t.jsx)(w.Provider,{value:{exercise:v,progress:S,currentQuestion:eu,currentQuestionIndex:ed,isLastQuestion:ep,isFirstQuestion:0===ed,questionStartTime:_,userAnswer:b,isAnswered:Q,gradeResult:O,setUserAnswer:T,submitAnswer:er,skipQuestion:en,nextQuestion:es,previousQuestion:eo,jumpToQuestion:ei,completeExercise:ec,resetExercise:ea,startExercise:et,reviewMode:F,toggleReviewMode:el,getQuestionAttempt:em},children:a})},C=()=>{let e=(0,r.useContext)(w);if(void 0===e)throw Error("useExercise must be used within an ExerciseProvider");return e}}]);