(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,243970,e=>{"use strict";e.s(["Progress",()=>y],243970);var t=e.i(843476),r=e.i(271645),s=e.i(30030),n=e.i(248425),o="Progress",[i,c]=(0,s.createContextScope)(o),[a,l]=i(o),u=r.forwardRef((e,r)=>{var s,o,i,c;let{__scopeProgress:l,value:u=null,max:d,getValueLabel:p=m,...v}=e;(d||0===d)&&!x(d)&&console.error((s="".concat(d),o="Progress","Invalid prop `max` of value `".concat(s,"` supplied to `").concat(o,"`. Only numbers greater than 0 are valid max values. Defaulting to `").concat(100,"`.")));let y=x(d)?d:100;null===u||h(u,y)||console.error((i="".concat(u),c="Progress","Invalid prop `value` of value `".concat(i,"` supplied to `").concat(c,"`. The `value` prop must be:\n  - a positive number\n  - less than the value passed to `max` (or ").concat(100," if no `max` prop is set)\n  - `null` or `undefined` if the progress is indeterminate.\n\nDefaulting to `null`.")));let w=h(u,y)?u:null,I=g(w)?p(w,y):void 0;return(0,t.jsx)(a,{scope:l,value:w,max:y,children:(0,t.jsx)(n.Primitive.div,{"aria-valuemax":y,"aria-valuemin":0,"aria-valuenow":g(w)?w:void 0,"aria-valuetext":I,role:"progressbar","data-state":f(w,y),"data-value":null!=w?w:void 0,"data-max":y,...v,ref:r})})});u.displayName=o;var d="ProgressIndicator",p=r.forwardRef((e,r)=>{var s;let{__scopeProgress:o,...i}=e,c=l(d,o);return(0,t.jsx)(n.Primitive.div,{"data-state":f(c.value,c.max),"data-value":null!=(s=c.value)?s:void 0,"data-max":c.max,...i,ref:r})});function m(e,t){return"".concat(Math.round(e/t*100),"%")}function f(e,t){return null==e?"indeterminate":e===t?"complete":"loading"}function g(e){return"number"==typeof e}function x(e){return g(e)&&!isNaN(e)&&e>0}function h(e,t){return g(e)&&!isNaN(e)&&e<=t&&e>=0}p.displayName=d;var v=e.i(605458);function y(e){let{className:r,value:s,...n}=e;return(0,t.jsx)(u,{"data-slot":"progress",className:(0,v.cn)("bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",r),...n,children:(0,t.jsx)(p,{"data-slot":"progress-indicator",className:"bg-primary h-full w-full flex-1 transition-all",style:{transform:"translateX(-".concat(100-(s||0),"%)")}})})}},798031,e=>{"use strict";e.s(["default",()=>t]);let t=(0,e.i(475254).default)("circle-x",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]])},406321,e=>{"use strict";e.s(["default",()=>t]);let t=(0,e.i(475254).default)("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},373884,e=>{"use strict";e.s(["XCircle",()=>t.default]);var t=e.i(798031)},269638,e=>{"use strict";e.s(["CheckCircle",()=>t.default]);var t=e.i(406321)},985559,e=>{"use strict";e.s(["Alert",()=>o,"AlertDescription",()=>i]);var t=e.i(843476),r=e.i(225913),s=e.i(605458);let n=(0,r.cva)("relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",{variants:{variant:{default:"bg-card text-card-foreground",destructive:"text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90"}},defaultVariants:{variant:"default"}});function o(e){let{className:r,variant:o,...i}=e;return(0,t.jsx)("div",{"data-slot":"alert",role:"alert",className:(0,s.cn)(n({variant:o}),r),...i})}function i(e){let{className:r,...n}=e;return(0,t.jsx)("div",{"data-slot":"alert-description",className:(0,s.cn)("text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",r),...n})}},978618,e=>{"use strict";e.s(["normalizeForComparison",()=>s,"searchVietnamese",()=>n]);let t={à:"a",á:"a",ả:"a",ã:"a",ạ:"a",ă:"a",ằ:"a",ắ:"a",ẳ:"a",ẵ:"a",ặ:"a",â:"a",ầ:"a",ấ:"a",ẩ:"a",ẫ:"a",ậ:"a",è:"e",é:"e",ẻ:"e",ẽ:"e",ẹ:"e",ê:"e",ề:"e",ế:"e",ể:"e",ễ:"e",ệ:"e",ì:"i",í:"i",ỉ:"i",ĩ:"i",ị:"i",ò:"o",ó:"o",ỏ:"o",õ:"o",ọ:"o",ô:"o",ồ:"o",ố:"o",ổ:"o",ỗ:"o",ộ:"o",ơ:"o",ờ:"o",ớ:"o",ở:"o",ỡ:"o",ợ:"o",ù:"u",ú:"u",ủ:"u",ũ:"u",ụ:"u",ư:"u",ừ:"u",ứ:"u",ử:"u",ữ:"u",ự:"u",ỳ:"y",ý:"y",ỷ:"y",ỹ:"y",ỵ:"y",đ:"d",À:"A",Á:"A",Ả:"A",Ã:"A",Ạ:"A",Ă:"A",Ằ:"A",Ắ:"A",Ẳ:"A",Ẵ:"A",Ặ:"A",Â:"A",Ầ:"A",Ấ:"A",Ẩ:"A",Ẫ:"A",Ậ:"A",È:"E",É:"E",Ẻ:"E",Ẽ:"E",Ẹ:"E",Ê:"E",Ề:"E",Ế:"E",Ể:"E",Ễ:"E",Ệ:"E",Ì:"I",Í:"I",Ỉ:"I",Ĩ:"I",Ị:"I",Ò:"O",Ó:"O",Ỏ:"O",Õ:"O",Ọ:"O",Ô:"O",Ồ:"O",Ố:"O",Ổ:"O",Ỗ:"O",Ộ:"O",Ơ:"O",Ờ:"O",Ớ:"O",Ở:"O",Ỡ:"O",Ợ:"O",Ù:"U",Ú:"U",Ủ:"U",Ũ:"U",Ụ:"U",Ư:"U",Ừ:"U",Ứ:"U",Ử:"U",Ữ:"U",Ự:"U",Ỳ:"Y",Ý:"Y",Ỷ:"Y",Ỹ:"Y",Ỵ:"Y",Đ:"D"};function r(e){if(!e)return"";let r=e;for(let[e,s]of Object.entries(t))r=r.replace(RegExp(e,"g"),s);return r}function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return"";let{preserveCase:s=!1,preserveWhitespace:n=!1}=t,o=r(e);return o=o.replace(RegExp("[\\p{P}\\p{S}]+","gu"),""),n||(o=o.replace(/\s+/g," ").trim()),s||(o=o.toLowerCase()),o}function n(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e||!t)return!1;let n=r(e),o=r(t);return s?n.includes(o):n.toLowerCase().includes(o.toLowerCase())}},584647,e=>{"use strict";e.s(["useExerciseSession",()=>r]);var t=e.i(271645);function r(){let e=(0,t.useRef)(!1),r=(0,t.useRef)(!1),s=(0,t.useCallback)(async t=>{if(e.current)return console.warn("[useExerciseSession] Start already in progress"),null;e.current=!0;try{console.log("[useExerciseSession] Starting exercise:",t);let e=await fetch("/api/exercise/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({practiceSetId:t})}),r=await e.json();if(!e.ok||!r.success)return console.error("[useExerciseSession] Failed to start exercise:",{status:e.status,statusText:e.statusText,error:r.error,data:r}),null;return console.log("[useExerciseSession] Exercise started:",{practiceResultId:r.practiceResultId,attemptNo:r.attemptNo,resumed:r.resumed}),{practiceResultId:r.practiceResultId,attemptNo:r.attemptNo}}catch(e){return console.error("[useExerciseSession] Error starting exercise:",e),null}finally{e.current=!1}},[]);return{startExercise:s,submitExercise:(0,t.useCallback)(async e=>{if(r.current)return console.warn("[useExerciseSession] Submit already in progress"),{success:!1,error:"Submit already in progress"};r.current=!0;try{console.log("[useExerciseSession] Submitting exercise:",{practiceResultId:e.practiceResultId,scorePercent:e.scorePercent,passed:e.passed});let t=await fetch("/api/exercise/submit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(!t.ok||!r.success)return console.error("[useExerciseSession] Failed to submit exercise:",r.error),{success:!1,error:r.error};return console.log("[useExerciseSession] Exercise submitted successfully:",{isFirstPass:r.isFirstPass,coinsEarned:r.coinsEarned,xpEarned:r.xpEarned}),r}catch(e){return console.error("[useExerciseSession] Error submitting exercise:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}finally{r.current=!1}},[]),checkForResume:(0,t.useCallback)(async e=>{try{console.log("[useExerciseSession] Checking for in_progress session:",e);let t=await fetch("/api/exercise/resume?practiceSetId=".concat(e)),r=await t.json();if(!t.ok||!r.success)return console.error("[useExerciseSession] Failed to check resume:",r.error),null;if(r.practiceResult)return console.log("[useExerciseSession] Found in_progress session:",r.practiceResult.id),{practiceResultId:r.practiceResult.id,attemptNo:r.practiceResult.attemptNo};return console.log("[useExerciseSession] No in_progress session found"),null}catch(e){return console.error("[useExerciseSession] Error checking resume:",e),null}},[])}}},543687,971094,e=>{"use strict";e.s(["ExerciseProvider",()=>w,"useExercise",()=>I],543687);var t=e.i(843476),r=e.i(271645),s=e.i(794846),n=e.i(584647),o=e.i(912598),i=e.i(761163),c=e.i(545208);e.s(["calculateAccuracy",()=>h,"clearExerciseSession",()=>f,"getQuestionAttempt",()=>x,"gradeQuestion",()=>u,"isExercisePassed",()=>v,"loadExerciseSession",()=>m,"saveExerciseSession",()=>p,"saveQuestionAttempt",()=>g],971094);var a=e.i(978618);let l="1.0.0";function u(e,t){var r,s,n,o,i,c;switch(e.type){case"multiple-choice":{let s=t===e.correctChoiceId;return{isCorrect:s,score:+!!s,feedback:s?"Correct!":"Incorrect. The correct answer is: ".concat(null==(r=e.choices.find(t=>t.id===e.correctChoiceId))?void 0:r.text)}}case"word-matching":{let r=e.pairs.length,s=0,n=(s=Array.isArray(t)?t.filter(t=>e.pairs.some(e=>e.id===t)).length:Object.values(t||{}).filter(t=>e.pairs.some(e=>e.id===t.pairId&&e.vietnamese===t.vietnamese)).length)===r;return{isCorrect:n,score:s/r,feedback:n?"Perfect matching!":"".concat(s,"/").concat(r," pairs correct")}}case"synonyms-matching":{let r=e.pairs.length,s=0,n=(s=Array.isArray(t)?t.filter(t=>e.pairs.some(e=>e.id===t)).length:Object.values(t||{}).filter(t=>e.pairs.some(e=>e.id===t.pairId&&e.word2===t.word2)).length)===r;return{isCorrect:n,score:s/r,feedback:n?"All synonyms matched correctly!":"".concat(s,"/").concat(r," pairs correct")}}case"choose-words":{let r=e.question_data,l=Array.isArray(t)?t:[];if(r&&r.subtype&&r.data){let e=r.subtype;if("fill_in_blanks"===e){let e=(null==(n=r.data)||null==(s=n.blanks)?void 0:s.correct)||[],t=0;for(let r=0;r<e.length;r++)(0,a.normalizeForComparison)(l[r]||"")===(0,a.normalizeForComparison)(e[r]||"")&&t++;let o=e.length>0&&t===e.length&&l.length===e.length;return{isCorrect:o,score:e.length?t/e.length:0,feedback:o?"All blanks correct!":"".concat(t,"/").concat(e.length," blanks correct")}}if("translation"===e){let e=(null==(o=r.data)?void 0:o.tokens)||[],t=l.join(" ").trim(),s=((null==(i=r.data)?void 0:i.canonical_sentence)||e.join(" ")).trim(),n=(0,a.normalizeForComparison)(t),c=(0,a.normalizeForComparison)(s),u=0,d=Math.min(l.length,e.length);for(let t=0;t<d;t++)(0,a.normalizeForComparison)(l[t]||"")===(0,a.normalizeForComparison)(e[t]||"")&&u++;let p=e.length>0&&l.length===e.length&&n===c;return{isCorrect:p,score:e.length?u/e.length:0,feedback:p?"Perfect translation!":"".concat(u,"/").concat(e.length," tokens in correct order")}}{let e=(null==(c=r.data)?void 0:c.tokens)||[],t=0,s=Math.min(l.length,e.length);for(let r=0;r<s;r++)(0,a.normalizeForComparison)(l[r]||"")===(0,a.normalizeForComparison)(e[r]||"")&&t++;let n=e.length>0&&l.length===e.length&&t===e.length;return{isCorrect:n,score:e.length?t/e.length:0,feedback:n?"Perfect sentence!":"".concat(t,"/").concat(e.length," tokens in correct order")}}}let u=e.correctAnswer||[],d=0;for(let e of l){let t=(0,a.normalizeForComparison)(e);u.some(e=>(0,a.normalizeForComparison)(e)===t)&&d++}let p=u.length>0&&d===u.length&&l.length===u.length;return{isCorrect:p,score:u.length?d/u.length:0,feedback:p?"Perfect translation!":"".concat(d,"/").concat(u.length||0," words correct")}}case"error-correction":{let r=(0,a.normalizeForComparison)(t||"")===(0,a.normalizeForComparison)(e.target);return{isCorrect:r,score:+!!r,feedback:r?"Correct correction!":'The correct sentence is: "'.concat(e.target,'"')}}case"grammar-structure":{let r=t===e.correctChoiceId;return{isCorrect:r,score:+!!r,feedback:r?"Correct grammar!":"Incorrect. ".concat(e.hint||"Please review the grammar rule.")}}case"dialogue-completion":{let r=t===e.correctChoiceId;return{isCorrect:r,score:+!!r,feedback:r?"Good dialogue completion!":"Try a more appropriate response"}}case"role-play":{let r=t||[],s=e.steps.length,n=e.steps.filter((e,t)=>r[t]===e.expected).length,o=n/s,i=o>.5;return{isCorrect:i,score:o,feedback:i?"Great role-play! ".concat(n,"/").concat(s," steps correct (").concat(Math.round(100*o),"% accuracy)"):"".concat(n,"/").concat(s," steps correct (").concat(Math.round(100*o),"% accuracy). Try to get more than 50% correct next time!")}}default:return{isCorrect:!1,score:0,feedback:"Unknown question type"}}}function d(e,t){return"".concat("exercise",":").concat(e,":").concat(t||"default",":").concat(l)}function p(e,t,r){try{let s=d(e,t),n=m(e,t),o={exerciseId:e,version:l,status:"in_progress",startedAt:Date.now(),currentQuestionIndex:0,attempts:[],progress:{currentQuestionIndex:0,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1},...n,...r,lastUpdatedAt:Date.now()};localStorage.setItem(s,JSON.stringify(o))}catch(e){console.warn("Failed to save exercise session:",e)}}function m(e,t){try{let r=d(e,t),s=localStorage.getItem(r);if(!s)return null;let n=JSON.parse(s);if(n.version!==l)return console.warn("Exercise session version mismatch, starting fresh"),null;return n}catch(e){return console.warn("Failed to load exercise session:",e),null}}function f(e,t){try{let r=d(e,t);localStorage.removeItem(r)}catch(e){console.warn("Failed to clear exercise session:",e)}}function g(e,t,r){let s=m(e,t);s&&(s.attempts=s.attempts.filter(e=>e.questionId!==r.questionId),s.attempts.push(r),p(e,t,s))}function x(e,t,r){let s=m(e,t);return s&&s.attempts.find(e=>e.questionId===r)||null}function h(e){let t=e.correctAnswers+e.incorrectAnswers;return t>0?Math.round(e.correctAnswers/t*100):0}function v(e,t,r){return void 0!==t?e>=t:void 0!==r?e>=(({1:65,2:70,3:75,4:80,5:85})[r]||80):e>=80}let y=(0,r.createContext)(void 0),w=e=>{let{children:a,exerciseData:l,topicSlug:d,lessonSlug:w,urlQuestionIndex:I,onQuestionChange:C}=e,[E,k]=(0,r.useState)(null),[A,b]=(0,r.useState)({currentQuestionIndex:0,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1}),[S,T]=(0,r.useState)(null),[Q,q]=(0,r.useState)(!1),[O,P]=(0,r.useState)(null),[_,D]=(0,r.useState)(Date.now()),[R,F]=(0,r.useState)(!1),[N,z]=(0,r.useState)("main"),[j,U]=(0,r.useState)([]),[M,K]=(0,r.useState)({}),[Y,L]=(0,r.useState)(!1),{toast:J}=(0,s.useToast)(),{playSound:X}={playSound:(0,r.useCallback)(e=>{try{let t=new Audio("/sounds/".concat(e));t.volume=.6,t.play().catch(e=>{console.debug("Sound play failed:",e)})}catch(e){console.debug("Sound utility error:",e)}},[])},{startExercise:B,submitExercise:G,checkForResume:V}=(0,n.useExerciseSession)(),H=(0,o.useQueryClient)(),{user:W}=(0,c.useUserProfile)(),Z=(0,r.useRef)(!1),$=(0,r.useRef)(!1),ee=(0,r.useRef)(null);(0,r.useEffect)(()=>{l&&!Z.current&&(async()=>{try{if(!l.id){console.error("[ExerciseContext] Invalid exercise data - missing id:",l),J({title:"Error",description:"Invalid exercise data. Please refresh the page.",variant:"destructive"});return}let e=m(l.id,w),t=await V(l.id);if(t){console.log("[ExerciseContext] Resuming from API session:",t.practiceResultId),ee.current=t.practiceResultId;let r=e?Math.min(e.currentQuestionIndex,l.questions.length-1):0;k(l),b((null==e?void 0:e.progress)||{currentQuestionIndex:r,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1}),z((null==e?void 0:e.phase)||"main"),U((null==e?void 0:e.skippedQueueIds)||[]),K((null==e?void 0:e.skipCounts)||{})}else{console.error("[ExerciseContext] No active session found - redirecting to lesson page"),J({title:"No Active Session",description:"Please start the exercise from the lesson page.",variant:"destructive"}),window.location.href="/learn/".concat(d,"/").concat(w);return}Z.current=!0}catch(e){console.error("[ExerciseContext] Error initializing session:",e),J({title:"Initialization Error",description:"Could not initialize exercise. Please try again.",variant:"destructive"})}})()},[l,w,V,B,J]),(0,r.useEffect)(()=>{if(!E||I<0||I>=E.questions.length)return;let e=E.questions[I];if(!e)return;let t=x(E.id,w,e.id);b(e=>({...e,currentQuestionIndex:I})),T((null==t?void 0:t.userAnswer)||null),q(!!t),P((null==t?void 0:t.grade)||null),D(Date.now())},[I,E,w]),(0,r.useEffect)(()=>{if(console.log("[ExerciseContext] Completion check:",{pendingResultSave:Y,isSaving:$.current,hasExercise:!!E,completed:A.completed,hasEndTime:!!A.endTime}),!Y||$.current||!E||!A.completed||!A.endTime)return;let e=!1;return $.current=!0,(async()=>{if(console.log("[ExerciseContext] Starting handleCompletion"),!ee.current){console.error("[ExerciseContext] No practice result ID found, cannot save results"),J({title:"Session Error",description:"Exercise session not found. Your progress may not be saved.",variant:"destructive"});return}let e=m(E.id,w),t=(null==e?void 0:e.attempts)||[],r=E.questions.length,s=A.correctAnswers/r*100,n=r-A.correctAnswers-A.incorrectAnswers,o=Math.floor((A.endTime-A.startTime)/1e3),c=Math.round((A.endTime-A.startTime)/6e4),a=h(A),l=v(a,void 0,E.zoneLevel);console.log("[ExerciseContext] Exercise metrics:",{practiceResultId:ee.current,totalQuestions:r,scorePercent:s,totalSkipped:n,timeSpentSeconds:o,studyTimeMinutes:c,accuracy:a,passed:l,attemptsCount:t.length});let u=await G({practiceResultId:ee.current,practiceSetId:E.id,scorePercent:s,totalCorrect:A.correctAnswers,totalIncorrect:A.incorrectAnswers,totalSkipped:n,timeSpentSeconds:o,passed:l,attempts:t});if(!u){console.error("[ExerciseContext] Failed to submit exercise results to API"),J({title:"Save Failed",description:"Your progress could not be saved. Please try again.",variant:"destructive"});return}if(console.log("[ExerciseContext] Exercise result submitted successfully:",u),(null==W?void 0:W.id)&&u.topicId&&u.lessonId){console.log("[ExerciseContext] Applying optimistic update and invalidating cache for topic:",u.topicId);let e=u.topicId,t=u.lessonId,r=i.queryKeys.lessonProgress.topic(W.id,e);H.getQueryData(r),H.setQueryData(r,r=>{if(!r||!Array.isArray(r))return r;let n=r.findIndex(e=>e.lesson_id===t);if(!(n>=0))return[...r,{lesson_id:t,topic_id:e,best_score_percent:s,total_attempts:1,status:l?"passed":"in_progress",last_attempted_at:new Date().toISOString(),passed_at:l?new Date().toISOString():null}];{let e=[...r];return e[n]={...e[n],best_score_percent:Math.max(s,e[n].best_score_percent||0),total_attempts:(e[n].total_attempts||0)+1,status:l?"passed":"in_progress",last_attempted_at:new Date().toISOString(),passed_at:l?new Date().toISOString():e[n].passed_at},e}}),H.invalidateQueries({queryKey:i.queryKeys.lessonProgress.topic(W.id,e)}),H.invalidateQueries({queryKey:i.queryKeys.user.progress()}),H.invalidateQueries({queryKey:i.queryKeys.quests.progress()})}f(E.id,w),ee.current=null;let d=u.isFirstPass?"Earned ".concat(u.coinsEarned," coins and ").concat(u.xpEarned," XP!"):"Keep practicing to improve!";J({title:"Exercise Completed!",description:"Accuracy: ".concat(a,"%. ").concat(l?"Passed!":"Try again to improve."," ").concat(d),variant:l?"default":"destructive"})})().finally(()=>{$.current=!1,e||L(!1)}),()=>{e=!0}},[Y,E,A.completed,A.endTime,A.correctAnswers,A.incorrectAnswers,A.startTime,w,J,G,H,null==W?void 0:W.id]);let et=(0,r.useCallback)((e,t,r)=>{k(e);let s=m(e.id,r);if(s)b(s.progress),setTimeout(()=>C(s.currentQuestionIndex),0);else{let t={currentQuestionIndex:0,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1};b(t),p(e.id,r,{status:"in_progress",currentQuestionIndex:0,progress:t}),setTimeout(()=>C(0),0)}T(null),q(!1),P(null),D(Date.now()),L(!1)},[C]),er=(0,r.useCallback)(()=>{if(!E||!E.questions[A.currentQuestionIndex]||Q)return;let e=E.questions[A.currentQuestionIndex],t=Date.now()-_,r=u(e,S);r.isCorrect?X("correct.mp3"):X("incorrect.wav");let s={questionId:e.id,userAnswer:S,grade:r,timeSpentMs:t,timestamp:Date.now(),questionType:e.type};g(E.id,w,s);let n={...A,correctAnswers:A.correctAnswers+ +!!r.isCorrect,incorrectAnswers:A.incorrectAnswers+ +!r.isCorrect};if(b(n),"skipped"===N){let t=e.id;if(j.includes(t)){let e=j.filter(e=>e!==t);U(e),p(E.id,w,{skippedQueueIds:e,skipCounts:M,phase:N})}}p(E.id,w,{currentQuestionIndex:A.currentQuestionIndex,progress:n}),q(!0),P(r)},[E,S,Q,_,A,w,N,j,M,X]),es=(0,r.useCallback)(()=>{var e;if(!E)return;let t=E.questions.length;if("main"===N){let e=A.currentQuestionIndex+1;if(e>=t){if(j.length>0){z("skipped"),p(E.id,w,{phase:"skipped"});let e=j[0],t=E.questions.findIndex(t=>t.id===e);t>=0&&setTimeout(()=>C(t),0);return}let e=Date.now();b({...A,endTime:e,completed:!0}),L(!0);return}setTimeout(()=>C(e),0);return}let r=null==(e=E.questions[A.currentQuestionIndex])?void 0:e.id,s=r?j.indexOf(r):-1,n=s>=0?s+1:0;if(n<j.length){let e=j[n],t=E.questions.findIndex(t=>t.id===e);t>=0&&setTimeout(()=>C(t),0);return}let o=Date.now();b({...A,endTime:o,completed:!0}),L(!0)},[E,C,N,A,j]),en=(0,r.useCallback)(()=>{if(!E)return;let e=E.questions[A.currentQuestionIndex];if(!e)return;X("flip.mp3");let t=e.id;K(e=>{let r=(e[t]||0)+1,s={...e,[t]:r};return p(E.id,w,{skipCounts:s,skippedQueueIds:j,phase:N}),s});let r=(M[t]||0)+1;if(r>=3){let s={questionId:t,userAnswer:null,grade:{isCorrect:!1,score:0,feedback:"Marked incorrect after 3 skips"},timeSpentMs:Date.now()-_,timestamp:Date.now(),status:"skipped",questionType:e.type};g(E.id,w,s);let n={...A,incorrectAnswers:A.incorrectAnswers+1};b(n);let o=j.indexOf(t),i=j;if(o>=0&&U(i=[...j.slice(0,o),...j.slice(o+1)]),p(E.id,w,{skippedQueueIds:i,skipCounts:{...M,[t]:r},progress:n,phase:N}),"main"===N){let e=A.currentQuestionIndex+1;if(e<E.questions.length)return void setTimeout(()=>C(e),0);if(i.length>0){z("skipped");let e=i[0],t=E.questions.findIndex(t=>t.id===e);t>=0&&setTimeout(()=>C(t),0);return}let t=Date.now();return b({...n,endTime:t,completed:!0}),void L(!0)}{let e=j.indexOf(t),r=e>=0&&e<i.length?i[e]:i[0];if(r){let e=E.questions.findIndex(e=>e.id===r);e>=0&&setTimeout(()=>C(e),0);return}let s=Date.now();b({...n,endTime:s,completed:!0}),L(!0);return}}if("main"===N){let e=j.includes(t)?j:[...j,t];e!==j?(U(e),p(E.id,w,{skippedQueueIds:e,skipCounts:{...M,[t]:r},phase:N})):p(E.id,w,{skipCounts:{...M,[t]:r},phase:N});let s=A.currentQuestionIndex+1;if(s<E.questions.length)return void setTimeout(()=>C(s),0);if(e.length>0){z("skipped"),p(E.id,w,{phase:"skipped"});let t=e[0],r=E.questions.findIndex(e=>e.id===t);r>=0&&setTimeout(()=>C(r),0);return}let n=Date.now();return b({...A,endTime:n,completed:!0}),void L(!0)}{let e=j.indexOf(t);if(e>=0){let s=[...j.slice(0,e),...j.slice(e+1),t];U(s),p(E.id,w,{skippedQueueIds:s,skipCounts:{...M,[t]:r},phase:N});let n=s[e];if(n&&n!==t){let e=E.questions.findIndex(e=>e.id===n);e>=0&&setTimeout(()=>C(e),0)}}}},[E,w,C,N,A,_,M,j,X]),eo=(0,r.useCallback)(()=>{if(A.currentQuestionIndex<=0)return;let e=A.currentQuestionIndex-1;setTimeout(()=>C(e),0)},[A.currentQuestionIndex,C]),ei=(0,r.useCallback)(e=>{!E||e<0||e>=E.questions.length||setTimeout(()=>C(e),0)},[E,C]),ec=(0,r.useCallback)(()=>{if(!E)return;let e=Date.now(),t={...A,endTime:e,completed:!0};console.log("[ExerciseContext] completeExercise called",{exerciseId:E.id,progress:t}),b(t),L(!0)},[E,A]),ea=(0,r.useCallback)(async()=>{if(!E)return;f(E.id,w),Z.current=!1,ee.current=null;let e=await B(E.id);e&&(ee.current=e.practiceResultId,console.log("[ExerciseContext] New session created on reset:",ee.current)),b({currentQuestionIndex:0,correctAnswers:0,incorrectAnswers:0,startTime:Date.now(),completed:!1}),T(null),q(!1),P(null),D(Date.now()),F(!1),z("main"),U([]),K({}),L(!1),setTimeout(()=>C(0),0)},[E,w,C,B]),el=(0,r.useCallback)(()=>{F(e=>!e)},[]),eu=E?E.questions[A.currentQuestionIndex]:null,ed=A.currentQuestionIndex,ep=!!E&&ed===E.questions.length-1,em=(0,r.useCallback)(e=>E?x(E.id,w,e):null,[E,w]);return(0,t.jsx)(y.Provider,{value:{exercise:E,progress:A,currentQuestion:eu,currentQuestionIndex:ed,isLastQuestion:ep,isFirstQuestion:0===ed,questionStartTime:_,userAnswer:S,isAnswered:Q,gradeResult:O,setUserAnswer:T,submitAnswer:er,skipQuestion:en,nextQuestion:es,previousQuestion:eo,jumpToQuestion:ei,completeExercise:ec,resetExercise:ea,startExercise:et,reviewMode:R,toggleReviewMode:el,getQuestionAttempt:em},children:a})},I=()=>{let e=(0,r.useContext)(y);if(void 0===e)throw Error("useExercise must be used within an ExerciseProvider");return e}}]);